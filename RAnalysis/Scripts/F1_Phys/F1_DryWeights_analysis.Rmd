---
title: "F1_DryWeights_analysis"
author: "Samuel Gurr"
date: "2024-3-1"
output: html_document
---

# Objectives: 

* (i) view the mean, variation, and number of samples

* (ii) plot the data 

* (iii) run stats

### set up load libraries and set working dir for the script 
```{r setup, include= FALSE, echo = FALSE}

# LOAD PACKAGES :::::::::::::::::::::::::::::::::::::::::::::::::::::::
library(dplyr)
library(ggplot2)
library(forcats)
library(lme4)
library(lmerTest)
library(performance)
library(car)
library(ggpubr)
library(SciViews)
library(Rmisc)
library(ggpmisc)
library(tidyr)
# SET WORKING DIRECTORY :::::::::::::::::::::::::::::::::::::::::::::::
# knitr::opts_knit$set(root.dir = "C:/Users/samjg/Documents/Github_repositories/EAD-ASEB-Airradians_F1F2_Growout_OA/RAnalysis")
knitr::opts_knit$set(root.dir = "C:/Users/samuel.gurr/Documents/Github_repositories/EAD-ASEB-Airradians_F1F2_Growout_OA/RAnalysis")

```

## Load & edit  data 

```{r, load data}

# F1s
F1_dryweights <- read.csv(file="Data/Physiology/Dry_weights/F1/cumulative_raw/F1_dry_weights_raw_2.csv",
                          header=T,stringsAsFactors=FALSE, 
                          fileEncoding="latin1") 

# unique dates for the dry weight data 
unique(F1_dryweights$Date_sampled)
# "9/14/2021"  "9/30/2021"  "10/26/2021" "12/2/2021"  "2/2/2022"   "3/2/2022"   "3/16/2022"  "3/28/2022"  "4/26/2022" 
# "5/26/2022"  "6/29/2022"

F1_dryweights <- F1_dryweights[!is.na(F1_dryweights$pH),] %>% # master data file
                    dplyr::mutate(pCO2 = case_when(pH == 8 ~ "500 μatm", # add column for pCO2
                                                   pH == 7.5 ~ "800 μatm")) %>% 
                    dplyr::mutate(Age = case_when(Date_sampled == "9/14/2021" ~  50, 
                                                  Date_sampled == "9/30/2021" ~  65, 
                                                  Date_sampled == "10/26/2021" ~  92,  # add column for Age in days
                                                  Date_sampled == "12/2/2021" ~ 129,
                                                  Date_sampled == "2/2/2022" ~ 191,
                                                  # Date_sampled == "2/28/2022" ~ 217,
                                                  Date_sampled == "3/2/2022" ~ 219,
                                                  Date_sampled == "3/16/2022" ~ 233,
                                                  Date_sampled == "3/28/2022" ~ 245,
                                                  Date_sampled == "4/26/2022" ~ 274,
                                                  Date_sampled == "5/26/2022" ~ 304,
                                                  Date_sampled == "6/29/2022" ~ 338))

# View(F1_dryweights)
F1_dryweights %>% filter(Age %in% 245)

# View(F1_dryweights %>% dplyr::select(Date_sampled, Dry_Gonad_weight_g,pH,Tank_Replicate) %>% group_by(Date_sampled,pH,Tank_Replicate) %>% dplyr::summarise(n=n()))
```

# Calculations of Gonad and Somatic metrics

```{r calculated values }
colnames(F1_dryweights)
F1_dryweights_calc <- F1_dryweights %>% 
                          dplyr::mutate(
                            # AGSI = (Gonad organic weight / total ash free dry weight) / 100;  organic weight = (dry weight - ash weight)
                            AGSI = ((Dry_Gonad_weight_g-Ash_Inorganic_Gonad_Tissue_g)/Tissue_AFDW_g) *100,
                            # AMSI = the same as AGSI but with adductor muscle
                            AMSI = ((Dry_Adductor_Tissue_g-Ash_Inorganic_.Adductor_Tissue_g)/Tissue_AFDW_g) *100,
                            # AMSSI = the same as AGSI but with BOTH muscle and somatic
                            AMSSI = ( ((Dry_Adductor_Tissue_g-Ash_Inorganic_.Adductor_Tissue_g)+
                                         (Dry_Somatic_Tissue_g-Ash_Inorganic_.Somatic_Tissue_g))/Tissue_AFDW_g) *100)
# View(F1_dryweights_calc)

# View(F1_dryweights_calc %>% dplyr::filter(Date_sampled %in% '3/16/2022'))
```


# Important! 
* During the rearing we split from N =4 (A, B, C, D) to N = 8 ( A-H) 
* At this first split, A was divided to E, B divided into F, and so on - essentially these are 'subreplicates' of the same 
originale replicate tank 
* Later, all of E-H were culled at 4/26 but before this, we destructively sampled. 

* Objective, we need to take means of all replicate tanks, however merge A+E, B+F, C+G, and D+H
- step 1, get the mean by tank replicate 
- step 2, convert all occurances of E to A and so on
- step 3, run the mean again to get the median 
- done
# raw data plots of target measurements


```{r Steps 1-3 to acheive master means data}

# first, lets reshape to assist in calculating all the means in LONG format

F1_dryweights_calc$Shell_length_mm <- as.numeric(F1_dryweights_calc$Shell_length_mm)

F1_dryweights_calc.long <- F1_dryweights_calc %>% 
                                  dplyr::mutate(row = row_number()) %>% 
                                  # because there are duplicates - complicates pivot_wider later
                                  dplyr::select(Age, pCO2, Tank_Replicate, row,
                                                Shell_length_mm,
                                                Dry_Shell_weight_g, Dry_Gonad_weight_g, 
                                                Dry_Adductor_Tissue_g, Dry_Somatic_Tissue_g, 
                                                Tissue_AFDW_g, Total_Dry_Tissue_g, Total_AFDW_g, 
                                                Whole_animal_dry_weight_g) %>% 
                                  tidyr::pivot_longer(
                                    cols = c('Shell_length_mm',
                                             'Dry_Shell_weight_g', 'Dry_Gonad_weight_g', 
                                             'Dry_Adductor_Tissue_g', 'Dry_Somatic_Tissue_g', 
                                             'Tissue_AFDW_g', 'Total_Dry_Tissue_g', 'Total_AFDW_g', 
                                             'Whole_animal_dry_weight_g'), 
                                    names_to = "measurement",
                                    values_to = "value"
                                  ) %>% 
                                    na.omit()

## step 1 calc means by replicate tank 
View(F1_dryweights_calc.long %>% dplyr::filter(Age == 233 & measurement %in% 'Dry_Gonad_weight_g' & pCO2  %in% '500 μatm'))

F1_dryweights_calc.long.MEANS    <- F1_dryweights_calc.long %>% 
                                    summarySE(measurevar="value", 
                                               groupvars=c("Age","pCO2", "Tank_Replicate", "measurement")) %>% 
                                    dplyr::arrange(as.numeric(Age), measurement, pCO2, Tank_Replicate)

write.csv(F1_dryweights_calc.long.MEANS, "Output/DryWeights/F1/F1_N_per_Replicate_MeanSE.csv")

## step 3:  convert E-H to A-D and summarise again to get the median 
# * note: ignore sd, se, etc, as there as N now ==1 or 2 in all cases, refer to the output file above 
# if you want the actual N for each replicate along with the variation within replicate!

F1_dryweights_calc.long.MEANS_master <- F1_dryweights_calc.long.MEANS %>%  # noew convert and resummarize by tank
                        dplyr::mutate(Tank_Replicate = case_when(
                                      Tank_Replicate == 'E' ~ 'A', #convert E to A
                                      Tank_Replicate == 'F' ~ 'B', #convert F to B
                                      Tank_Replicate == 'G' ~ 'C', #convert G to C
                                      Tank_Replicate == 'H' ~ 'D', #convert H to D
                                      .default = (as.character(Tank_Replicate)) # for cases A-D, keep em my mans
                                    )) %>% 
                        summarySE(measurevar="value", 
                                  groupvars=c("Age","pCO2", "Tank_Replicate", "measurement")) %>% # summarize again
                        dplyr::arrange(as.numeric(Age), measurement, pCO2, Tank_Replicate) %>% 
                        dplyr::select(-c(sd, se, ci)) # N = number of means!!! N = 2 means there awas a A+E, etc and mean == median

```


```{r all diagnostic plotting}

#plot all data by replicate 

Raw_all_data <-ggplot(F1_dryweights_calc.long,
                                 aes(x=paste0(pCO2,Tank_Replicate), 
                                     y=value, 
                                     colour=factor(pCO2)),
                                      stat="identity") +
                           scale_colour_manual(breaks=c("500 μatm", "800 μatm"), 
                                             values=c("forestgreen","darkorange2")) +
                           geom_point(aes(colour = pCO2), 
                                            position = position_dodge2(width = 0.5)) + 
                           geom_violin() +
                           labs(x ="Age (dpf)", y = "value") +
                          # scale_y_continuous(expand = c(0, 0), limits = c(0, NA)) +
                          theme_classic() +
                          theme(panel.grid.major = element_blank(), 
                                panel.grid.minor = element_blank(), 
                                # axis.title.y=element_blank(),
                                # axis.title.x=element_blank(),
                                axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=1),
                                axis.text=element_text(size=8),
                                plot.title = element_text(size=12),
                                legend.position="none") +
                          facet_wrap(~Age*measurement, scales="free")

pdf("Output/DryWeights/F1/all_raw/Raw_data_bytank.pdf", height=15, width =30)
print(Raw_all_data)
dev.off()

Raw_MeanSE <-ggplot(F1_dryweights_calc.long.MEANS_master,
                                 aes(x=factor(Age), 
                                     y=value, 
                                     colour=factor(pCO2)),
                                      stat="identity") +
                           scale_colour_manual(breaks=c("500 μatm", "800 μatm"), 
                                             values=c("forestgreen","darkorange2")) +
                           geom_point(aes(colour = pCO2), 
                                            position = position_dodge2(width = 0.5)) + 
                           stat_summary(fun.y="mean", size = 0.8,
                                              position = position_dodge2(width = 0.5)) +
                           stat_summary(fun.min = function(x) mean(x) - sd(x)/sqrt(length(x)), 
                                              fun.max = function(x) mean(x) + sd(x)/sqrt(length(x)),
                                              geom = 'errorbar', width = 0.25, size = 1,
                                              position = position_dodge2(width = 0.5)) + 
                           labs(title="Mean + SE data", 
                                                      x ="Age (dpf)", 
                                                      y = "value") +
                          # scale_y_continuous(expand = c(0, 0), limits = c(0, NA)) +
                          theme_classic() +
                          theme(panel.grid.major = element_blank(), 
                                panel.grid.minor = element_blank(), 
                                # axis.title.y=element_blank(),
                                # axis.title.x=element_blank(),
                                axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=1),
                                axis.text=element_text(size=8),
                                plot.title = element_text(size=12),
                                legend.position="none") +
                          facet_wrap(~measurement, scales = "free_y")

pdf("Output/DryWeights/F1/all_raw/MeanSE_data.pdf", height=8, width =8)
print(Raw_MeanSE)
dev.off()

Raw_MeanSE.reproductivestage <-ggplot(F1_dryweights_calc.long.MEANS_master %>% dplyr::filter(Age > 200),
                                 aes(x=factor(Age), 
                                     y=value, 
                                     colour=factor(pCO2)),
                                      stat="identity") +
                           scale_colour_manual(breaks=c("500 μatm", "800 μatm"), 
                                             values=c("forestgreen","darkorange2")) +
                           geom_point(aes(colour = pCO2), 
                                            position = position_dodge2(width = 0.5)) + 
                           stat_summary(fun.y="mean", size = 0.8,
                                              position = position_dodge2(width = 0.5)) +
                           stat_summary(fun.min = function(x) mean(x) - sd(x)/sqrt(length(x)), 
                                              fun.max = function(x) mean(x) + sd(x)/sqrt(length(x)),
                                              geom = 'errorbar', width = 0.25, size = 1,
                                              position = position_dodge2(width = 0.5)) + 
                           labs(title="Mean + SE data", 
                                                      x ="Age (dpf)", 
                                                      y = "value") +
                          # scale_y_continuous(expand = c(0, 0), limits = c(0, NA)) +
                          theme_classic() +
                          theme(panel.grid.major = element_blank(), 
                                panel.grid.minor = element_blank(), 
                                # axis.title.y=element_blank(),
                                # axis.title.x=element_blank(),
                                axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=1),
                                axis.text=element_text(size=8),
                                plot.title = element_text(size=12),
                                legend.position="none") +
                          facet_wrap(~measurement, scales = "free_y")

pdf("Output/DryWeights/F1/all_raw/MeanSE_data_reprodutive_stages.pdf", height=8, width =8)
print(Raw_MeanSE.reproductivestage)
dev.off()

```


# Proportion Gonad to Total tissue weight 

* here we do no require a bfactor becuase we are already scalling to the individual!

### Build poroprtion dataset 
```{r Proportion calculate}


Proportion_master <- F1_dryweights_calc.long %>% 
                             #F2_dryweights_calc.long.MEANS_master %>% 
                             dplyr::filter(measurement %in% c('Dry_Gonad_weight_g', 
                                                              'Dry_Somatic_Tissue_g', 
                                                              'Dry_Adductor_Tissue_g',
                                                              'Total_Dry_Tissue_g')) %>%
                            tidyr::pivot_wider(
                                                names_from = measurement,
                                                values_from = value
                            ) %>% 
                            # na.omit() %>% # omit cases where we do not have gonad weight (there are a few!)
                            dplyr::mutate(Proportion_Gonad    = Dry_Gonad_weight_g/Total_Dry_Tissue_g,
                                          Proportion_Adductor = Dry_Adductor_Tissue_g/Total_Dry_Tissue_g,
                                          Proportion_Somatic  = Dry_Somatic_Tissue_g/Total_Dry_Tissue_g,
                                          Sanity_check_prop_total = (Proportion_Gonad +  
                                                                      Proportion_Adductor + 
                                                                       Proportion_Somatic)) %>% 
                            dplyr::mutate(Tank_Replicate = case_when(
                                      Tank_Replicate == 'E' ~ 'A', #convert E to A
                                      Tank_Replicate == 'F' ~ 'B', #convert F to B
                                      Tank_Replicate == 'G' ~ 'C', #convert G to C
                                      Tank_Replicate == 'H' ~ 'D', #convert H to D
                                      .default = (as.character(Tank_Replicate)) # for cases A-D, keep em my mans
                                    )) 

?summarySE
Proportion_master %>% Rmisc::summarySE(groupvars = c('Age', 'pCO2', 'Tank_Replicate'), measurevar = 'Proportion_Gonad')
```

### Plot porportion dataset
```{r Propotion stacked bar plot}

Proportion_master_long <- Proportion_master[,c(1:2,9:11)] %>%  
                              tidyr::pivot_longer(cols = c(3:5), names_to='prop_metric', values_to='value') 



#convert metric to ordered factor
Proportion_master_long_ordered             <- Proportion_master_long[order(Proportion_master_long$prop_metric ),]
Proportion_master_long_ordered$prop_metric <- factor(Proportion_master_long_ordered$prop_metric, 
                                                     levels = rev(c(rep("Proportion_Somatic",1), 
                                                                    rep("Proportion_Adductor",1), 
                                                                    rep("Proportion_Gonad",1))))

Proportion_master_long_MEANS <- Proportion_master_long_ordered %>%
                                    dplyr::mutate(prop_metric = 
                                                    forcats::fct_relevel(prop_metric,
                                                                         "Proportion_Somatic",
                                                                         "Proportion_Gonad",
                                                                         "Proportion_Adductor")) %>% 
                                    group_by(Age, pCO2, prop_metric) %>% 
                                    dplyr::summarise(mean = mean(value), sd =sd(value)) %>% 
                                    mutate(y_pos = cumsum(mean)) 


Proportion_master_long_MEANS$prop_metric <- factor(Proportion_master_long_MEANS$prop_metric, 
                                                     levels = rev(c(rep("Proportion_Gonad",1), 
                                                                    rep("Proportion_Somatic",1), 
                                                                    rep("Proportion_Adductor",1))))

# stacked proportion plot
pd <- position_dodge2(width = 0.2)
Proportion_master_long_MEANS$prop_metric <- as.character(Proportion_master_long_MEANS$prop_metric)


Proportion_StackedBarplot <- Proportion_master_long_MEANS %>% 
                                drop_na(mean) %>% 
                                ggplot(aes(x = as.factor(Age), 
                                           y = mean, 
                                           fill = prop_metric)) + 
                                geom_bar(stat = "identity", width=0.7) + 
                                scale_fill_manual(values = c("grey80","grey40", "grey20")) +
                                #scale_fill_manual(values = c("#0072B2", "#D55E00")) + # colorblindness palette blue and orange
                                geom_errorbar(aes(ymax = y_pos + sd, 
                                                  ymin=y_pos - sd), 
                                              stat = "identity", 
                                              width = 0.1, 
                                              alpha = 0.7, 
                                              position = pd) + 
                                facet_wrap(~pCO2) + 
                                scale_alpha_manual(values=c(seq(0.3,1, length.out = 3))) + 
                                theme_bw() + 
                                scale_y_continuous(breaks = seq(from = 0, to = 100, by = 10)) + 
                                ylim(0,1.1)+
                                ylab("Dry Tissue Proportions (%)") 
Proportion_StackedBarplot


pdf("Output/DryWeights/F1/Proportion_DryWeight_StakedBarplot.pdf", height=4, width =6)
print(Proportion_StackedBarplot)
dev.off()

```

```{r Proportion mean SE plot}

Proportion_Gonad_plot <- Proportion_master %>% 
                          # dplyr::filter((!value > 20)) %>% 
                          ggplot(aes(x=factor(Age), y=Proportion_Gonad, colour=factor(pCO2)),stat="identity") +
                           scale_colour_manual(breaks=c("500 μatm", "800 μatm", "1200 μatm"), 
                                           values=c("forestgreen","darkorange2", "purple")) +
                          stat_summary(fun.y="mean", size = 0.8,
                                        position = position_dodge2(width = 0.25)) +
                          stat_summary(fun.min = function(x) mean(x) - sd(x)/sqrt(length(x)), 
                                        fun.max = function(x) mean(x) + sd(x)/sqrt(length(x)),
                                        geom = 'errorbar', width = 0.25, size = 1,
                                        position = position_dodge2(width = 0.5)) + 
                          labs(title="Proportion Gonad to Total Tissue", 
                               x ="Age (dpf)", 
                               y = "Dry gonad (proportion)") +
                          theme_classic() +
                          theme(panel.grid.major = element_blank(), 
                                panel.grid.minor = element_blank(), 
                                axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=1),
                                axis.text=element_text(size=8),
                                plot.title = element_text(size=12),
                                legend.position="none")


Proportion_Adductor_plot <- Proportion_master %>% 
                          # dplyr::filter((!value > 20)) %>% 
                          ggplot(aes(x=factor(Age), y=Proportion_Adductor, colour=factor(pCO2)),stat="identity") +
                           scale_colour_manual(breaks=c("500 μatm", "800 μatm", "1200 μatm"), 
                                           values=c("forestgreen","darkorange2", "purple")) +
                          stat_summary(fun.y="mean", size = 0.8,
                                        position = position_dodge2(width = 0.25)) +
                          stat_summary(fun.min = function(x) mean(x) - sd(x)/sqrt(length(x)), 
                                        fun.max = function(x) mean(x) + sd(x)/sqrt(length(x)),
                                        geom = 'errorbar', width = 0.25, size = 1,
                                        position = position_dodge2(width = 0.5)) + 
                          labs(title="Proportion Adductor to Total Tissue", x ="Age (dpf)", y = "Dry Adductor (proportion)") +
                          theme_classic() +
                          theme(panel.grid.major = element_blank(), 
                                panel.grid.minor = element_blank(), 
                                axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=1),
                                axis.text=element_text(size=8),
                                plot.title = element_text(size=12),
                                legend.position="none")


Proportion_Somatic_plot <- Proportion_master %>% 
                          # dplyr::filter((!value > 20)) %>% 
                          ggplot(aes(x=factor(Age), y=Proportion_Somatic, colour=factor(pCO2)),stat="identity") +
                           scale_colour_manual(breaks=c("500 μatm", "800 μatm", "1200 μatm"), 
                                           values=c("forestgreen","darkorange2", "purple")) +
                          stat_summary(fun.y="mean", size = 0.8,
                                        position = position_dodge2(width = 0.25)) +
                          stat_summary(fun.min = function(x) mean(x) - sd(x)/sqrt(length(x)), 
                                        fun.max = function(x) mean(x) + sd(x)/sqrt(length(x)),
                                        geom = 'errorbar', width = 0.25, size = 1,
                                        position = position_dodge2(width = 0.5)) + 
                          labs(title="Proportion Somatic to Total Tissue", x ="Age (dpf)", y = "Dry Somatic (proportion)") +
                          theme_classic() +
                          theme(panel.grid.major = element_blank(), 
                                panel.grid.minor = element_blank(), 
                                axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=1),
                                axis.text=element_text(size=8),
                                plot.title = element_text(size=12),
                                legend.position="none")


# Lets look at shell length for good measure.. Remember to omit lines that did not have gonad! 
Shell_Length_plot <- F1_dryweights_calc.long %>% 
                            dplyr::filter(measurement %in% c('Dry_Gonad_weight_g', 'Shell_length_mm')) %>%
                            tidyr::pivot_wider(
                                                names_from = measurement,
                                                values_from = value
                            ) %>% 
                            na.omit() %>% # omit cases where we do not have gonad weight (there are a few!)
                            ggplot(aes(x=factor(Age), y=Shell_length_mm, colour=factor(pCO2)),stat="identity") +
                            scale_colour_manual(breaks=c("500 μatm", "800 μatm", "1200 μatm"), 
                                           values=c("forestgreen","darkorange2", "purple")) +
                            stat_summary(fun.y="mean", size = 0.8,
                                        position = position_dodge2(width = 0.25)) +
                            stat_summary(fun.min = function(x) mean(x) - sd(x)/sqrt(length(x)), 
                                        fun.max = function(x) mean(x) + sd(x)/sqrt(length(x)),
                                        geom = 'errorbar', width = 0.25, size = 1,
                                        position = position_dodge2(width = 0.5)) + 
                            labs(title="Shell length", x ="Age (dpf)", y = "shell length (mm)") +
                            theme_classic() +
                            theme(panel.grid.major = element_blank(), 
                                panel.grid.minor = element_blank(), 
                                axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=1),
                                axis.text=element_text(size=8),
                                plot.title = element_text(size=12),
                                legend.position="none")



# pdf("Output/DryWeights/F2/length_scaling/Dry_Gonad_byLength.pdf", height=8, width =8)
# ggarrange(bfactorGonad.Length.all, bfactorGonad.Length.pCO2,Gonad_bfactor.MeanSE, nrow=3)
# dev.off()

pdf("Output/DryWeights/F1/Proportion_DryWeight_MeanSE.pdf", height=6, width =8)
ggarrange(Proportion_Gonad_plot, Proportion_Adductor_plot , Proportion_Somatic_plot,Shell_Length_plot, nrow = 2, ncol = 2)
dev.off()


```

### Statistics on proportion data
```{r Proportion stats}


# Gonad (to total tissue)
F1_Proportion_Gonad_MEANS <- Proportion_master %>% 
                                    dplyr::select(Age,pCO2, Tank_Replicate,
                                                  Proportion_Gonad) %>% 
                                    summarySE(measurevar="Proportion_Gonad", 
                                               groupvars=c("Age","pCO2", "Tank_Replicate")) %>% 
                                    dplyr::arrange(as.numeric(Age))

F1_Proportion_Gonad_MEANS$DPvar    <- F1_Proportion_Gonad_MEANS$Proportion_Gonad
F1_Proportion_Gonad_MEANS$INDvar   <- F1_Proportion_Gonad_MEANS$pCO2
F1_Proportion_Gonad_MEANS$GROUPvar <- F1_Proportion_Gonad_MEANS$Age

ProportionGonad_stats <- as.data.frame(runstats(F1_Proportion_Gonad_MEANS)) # sig effect on Age 196 and 220
# No significant differences
ProportionGonad_ttest <- as.data.frame(run_ttest(F1_Proportion_Gonad_MEANS)) # sig effect on Age 196 and 220



# Adductpr (to total tissue)
F1_Proportion_Adductor_MEANS <- Proportion_master %>% 
                                    dplyr::select(Age,pCO2, Tank_Replicate,
                                                  Proportion_Adductor) %>% 
                                    summarySE(measurevar="Proportion_Adductor", 
                                               groupvars=c("Age","pCO2", "Tank_Replicate")) %>% 
                                    dplyr::arrange(as.numeric(Age))

F1_Proportion_Adductor_MEANS$DPvar    <- F1_Proportion_Adductor_MEANS$Proportion_Adductor
F1_Proportion_Adductor_MEANS$INDvar   <- F1_Proportion_Adductor_MEANS$pCO2
F1_Proportion_Adductor_MEANS$GROUPvar <- F1_Proportion_Adductor_MEANS$Age

ProportionAdductor_stats <- as.data.frame(runstats(F1_Proportion_Adductor_MEANS)) # 165, 196, 220 (220 is Kruskal Wallis!)
# No significnat differences
ProportionAdductor_ttest <- as.data.frame(run_ttest(F1_Proportion_Adductor_MEANS)) # 165, 196, 220 (220 is Kruskal Wallis!)



# Adductpr (to total tissue)
F1_Proportion_Somatic_MEANS <- Proportion_master %>% 
                                    dplyr::select(Age,pCO2, Tank_Replicate,
                                                  Proportion_Somatic) %>% 
                                    summarySE(measurevar="Proportion_Somatic", 
                                               groupvars=c("Age","pCO2", "Tank_Replicate")) %>% 
                                    dplyr::arrange(as.numeric(Age))

F1_Proportion_Somatic_MEANS$DPvar    <- F1_Proportion_Somatic_MEANS$Proportion_Somatic
F1_Proportion_Somatic_MEANS$INDvar   <- F1_Proportion_Somatic_MEANS$pCO2
F1_Proportion_Somatic_MEANS$GROUPvar <- F1_Proportion_Somatic_MEANS$Age

ProportionSomatic_stats <- as.data.frame(runstats(F1_Proportion_Somatic_MEANS)) # 165, 196, 220 (220 is Kruskal Wallis!)
# No significnat differences
ProportionSomatic_ttest <- as.data.frame(run_ttest(F1_Proportion_Somatic_MEANS)) # 165, 196, 220 (220 is Kruskal Wallis!)


ProportionTissues_Ttest <- rbind(ProportionGonad_ttest, ProportionAdductor_ttest, ProportionSomatic_ttest)
write.csv(ProportionTissues_Ttest, "Output/DryWeights/F1/F1_Proportion_DryWeights_Ttest_table.csv")



```



# Tissue Index

**About**: Use the Gonadal tissue index from: 
BonardeUi JC, Himmelman JH (1995) Examination of assumptions critical to body component indices: application to the giant scallop, Placopecten magellanicus. Can J Fish aquat Sciences 52(i1): 

*"In brief, Gonadal mass index (a) = (measured gonadal massX(shell height-b). The coefficient "b" is the common slope determined from the relation of gonadal mass to shell height (log transformed). The gonadal mass index (a) for each scallop is then transformed to the mean shell height of scallops collected  using the equation, gonad = a x (standard shell heightb), b being the pooled slope. This size was near the mean shell height of scallops collected"*

**EQ**
1) Gonadal mass index (a) = (measured gonadal mass) X (measured shell height -b)

2) Transformed gonadal mass index (a`) = (a) X (standard shell height b)

## Scaling exponent (b) 

* A few important aspects of this data contrbute to our rationale in the chosen b factor for this paper, however we will report all calculated b factors in a supplementary table 

* More samples were analyzed at the start of maturation (post winter) when the animals have smaller shell height than were measured later near spawning, therefore when we run 
log log regressions of shell height to dry weight we have a larger slope using all data points (more in smaller individuals causing a steeper slope) than when we take the mean within replicate 
so that data is not distributed disproportionately to smaller individuals. When we correct for these different scaling exponents, we get data that does not resemble the raw patterns 
when using all data - earlier dates (smaller animals) having high values. In summary we MUST take the mean of replicates to avoid disproportionally weighing scaling toward the smaller animals (early timepoints)
that were sample more heavily 

* During our dry weight measurements (post-winter) we found that shell growth/height differed between elevated and low pCO2 treamtent, therefore we must parse scaling exponents by treatment! 

* **In summary:** Use the mean data by replicate, and employ pCO2 treatment-specific b factors. Howeverm report all three (all, pCO2 moderate, pCO2 low). Also run regression analysis to see if 
the b factor regression are stiatistically different


## Standard shell height 

* Shell size standard of year 1 scallop: 
  - Epp, J., Bricelj, V. M., & Malouf, R. E. (1988). Seasonal partitioning and utilization of energy reserves in two age classes of the bay scallop Argopecten irradians irradians (Lamarck). Journal of
  Experimental Marine Biology and Ecology, 121(2), 113-136.
  - Used a size standard of 40 mm and 45 mm - review their Figure 3


  - Bricelj, V. M., Epp, J., & Malouf, R. E. (1987). Comparative physiology of young and old cohorts of bay scallop Argopecten irradians irradians (Lamarck): mortality, growth, and oxygen consumption. Journal of
  Experimental Marine Biology and Ecology, 112(2), 73-91.
  - standardized to 1 g tissue dry weight, this occured for year 1 scallops when ~42-43 mm shell height

* **In summary** use a shell size of 40 mm 


## Statistics function 'runstats'
```{r Statistic function}


runstats <- function(datafilename,  outputfilename) {
            # variables for both for loops
            DF_loop           <- data.frame(matrix(nrow = 1, ncol = 11)) # create dataframe to save during for loop
            colnames(DF_loop) <- c('Age_DPF', 'ShapiroWilk', 'ResidNorm', 
                                   'Levenes', 'HomogVar', 'model', 
                                   'DF.num' , 'DF.denom', 
                                   'F_val','P_val', 'SigDif') # names for comuns in the for loop
            
            unique(datafilename$Age)
            outputfilename <- data.frame()

            
            for (i in 1:length(unique(datafilename$Age))) {
              GROUPvar_loop <- unique(datafilename$GROUPvar)[i]
              Data_all      <- datafilename %>% dplyr::filter(GROUPvar %in% GROUPvar_loop)
              # Data_mean   <- Data_all %>% summarySE(measurevar="DPvar", 
              #                                       groupvars=c("group1","Tank_Replicate", "INDvar")) 
              
              AOVmod      <- aov(lm(Data_all$DPvar ~ as.factor(Data_all$INDvar))) # CHANGE HERE!
              KWmod       <- kruskal.test(Data_all$DPvar  ~ as.factor(Data_all$INDvar)) # CHANGE HERE!
              
              # DF_loop$About <- paste0("Gonad: All bfactor + mean by replicate")
              # DF_loop$About <- paste0("Gonad: All bfactor + all data")  # normality tests for the anova model - asign
              
              
              DF_loop$ShapiroWilk <- shapiro.test(resid(AOVmod))[[2]]
              DF_loop$ResidNorm   <- if( shapiro.test(resid(AOVmod))[[2]] > 0.05) {
                  'YES'} else {'NO'}
              DF_loop$Levenes     <- leveneTest(AOVmod)[[3]][[1]]
              DF_loop$HomogVar    <- if( leveneTest(AOVmod)[[3]][[1]] > 0.05) {
                  'YES'} else {'NO'}
                
              if(shapiro.test(resid(AOVmod))[[2]] > 0.05 & leveneTest(AOVmod)[[3]][[1]] > 0.05) {
                    DF_loop$model       <- 'one-way AOV; x ~ treatment'
                    DF_loop$DF.num      <- summary(AOVmod)[[1]][["Df"]][1]
                    DF_loop$DF.denom    <- summary(AOVmod)[[1]][["Df"]][2]
                    DF_loop$F_val       <- summary(AOVmod)[[1]][["F value"]][1]
                    DF_loop$P_val       <- summary(AOVmod)[[1]][["Pr(>F)"]][1]
                    DF_loop$SigDif      <- if( (summary(AOVmod)[[1]][["Pr(>F)"]][1]) > 0.05) {
                      'NO'} else {'YES'}
            
                  } else {
                    DF_loop$model       <- 'kruskal-wallis; x ~ treatment'
                    DF_loop$DF.num      <- (KWmod)[[2]][["df"]][1]
                    DF_loop$DF.denom    <- NA
                    DF_loop$F_val       <- NA
                    DF_loop$P_val       <- (KWmod)[[3]]
                    DF_loop$SigDif      <- if( ((KWmod)[[3]]) > 0.05) {
                      'NO'} else {'YES'}
                  }
              DF_loop$Age_DPF     <- GROUPvar_loop
              # asign loop and cumulative output table
              df                        <- data.frame(DF_loop) # name dataframe for this single row
              outputfilename <- rbind(outputfilename,DF_loop) #bind to a cumulative list dataframe
              # print(outputfilename) # print to monitor progress
              
            }
return(outputfilename)
}

library(lsr)

run_ttest <- function(datafilename,  outputfilename) {
            # variables for both for loops
            DF_loop           <- data.frame(matrix(nrow = 1, ncol = 13)) # create dataframe to save during for loop
            colnames(DF_loop) <- c('Age_DPF', 'model', 'ShapiroWilk', 'ResidNorm', 'Variance', 
                                   'HomogVar', 'DF.num' , 'DF.denom', 
                                   'Tstat','P_val', 'SigDif', 'Effsize') # names for comuns in the for loop
            
            unique(datafilename$Age)
            outputfilename <- data.frame()

            
            for (i in 1:length(unique(datafilename$Age))) {
              GROUPvar_loop <- unique(datafilename$GROUPvar)[i]
              Data_all      <- datafilename %>% dplyr::filter(GROUPvar %in% GROUPvar_loop)
              # Data_mean   <- Data_all %>% summarySE(measurevar="DPvar", 
              #                                       groupvars=c("group1","Tank_Replicate", "INDvar")) 
              
            # run assumptions 
            # normality of data 
            normality_A <- (Data_all %>% 
                                  group_by(as.factor(INDvar)) %>% 
                                  rstatix::shapiro_test(DPvar))$p[1]
            
            normality_B <- (Data_all %>% 
                                  group_by(as.factor(INDvar)) %>% 
                                  rstatix::shapiro_test(DPvar))$p[2]
            
            # equal variance 
            variance <- (Data_all %>% rstatix::levene_test(DPvar ~ as.factor(INDvar)))$p[1]
            
            # run all modles
            Ttestmod.eqvar      <- t.test(Data_all$DPvar ~ (as.factor(Data_all$INDvar)), 
                                           alternative = "greater",
                                           var.equal = TRUE)
            
            Ttestmod.noneqvar   <- t.test(Data_all$DPvar ~ (as.factor(Data_all$INDvar)),
                                           alternative = "greater",
                                           var.equal = FALSE)
            
            Wilcoxmod           <- wilcox.test(Data_all$DPvar ~ 
                                                 as.numeric(as.factor(Data_all$INDvar)))
            
            # run cohensd for effect size
            eff_size_cohensd            <- cohensD(DPvar ~ INDvar, data = Data_all, method = "pooled")
            eff_size_cohensd_unequal    <- cohensD(DPvar ~ INDvar, data = Data_all, method = "unequal") # if ttest d/n meet welchs assumption
            eff_size_wilcox             <- rstatix::wilcox_effsize(DPvar ~ INDvar, data = Data_all)
            
            # normality tests for the anova model - asign 
            DF_loop$ShapiroWilk <- paste0(normality_A, '; ',normality_B)
            
            DF_loop$ResidNorm   <- if(normality_A > 0.05 & normality_B > 0.05) {
              'YES'} else {'NO'}
            
            DF_loop$Variance     <- variance
            
            DF_loop$HomogVar    <- if( variance > 0.05) {
              'YES'} else {'NO'}
            
            if(normality_A > 0.05 & normality_B > 0.05 & variance > 0.05) {
                DF_loop$model       <- 'Welchs T test, equal variance'
                DF_loop$DF.num      <- map_df(list(Ttestmod.eqvar), tidy)$parameter[[1]]
                DF_loop$DF.denom    <- 'NA'
                DF_loop$Tstat       <- map_df(list(Ttestmod.eqvar), tidy)$statistic[[1]]
                DF_loop$P_val       <- map_df(list(Ttestmod.eqvar), tidy)$p.value[[1]]
                DF_loop$SigDif      <- if( (map_df(list(Ttestmod.eqvar), tidy)$p.value[[1]]) > 0.05) {
                  'NO'} else {'YES'}
                DF_loop$Effsize     <- signif(eff_size_cohensd[[1]], 3)
        
              } else if (normality_A > 0.05 & normality_B > 0.05 & variance < 0.05) {
                DF_loop$model       <- 'Welchs T test, non-equal variance'
                DF_loop$DF.num      <- map_df(list(Ttestmod.noneqvar), tidy)$parameter[[1]]
                DF_loop$DF.denom    <- 'NA'
                DF_loop$Tstat       <- map_df(list(Ttestmod.noneqvar), tidy)$statistic[[1]]
                DF_loop$P_val       <- map_df(list(Ttestmod.noneqvar), tidy)$p.value[[1]]
                DF_loop$SigDif      <- if( (map_df(list(Ttestmod.noneqvar), tidy)$p.value[[1]]) > 0.05) {
                  'NO'} else {'YES'}
                DF_loop$Effsize     <- signif(eff_size_cohensd_unequal[[1]], 3)
                
              } else {
                DF_loop$model       <- 'Wilcoxon rank sum exact test'
                DF_loop$DF.num      <- 'NA'
                DF_loop$DF.denom    <- 'NA'
                DF_loop$Tstat       <- map_df(list(Wilcoxmod), tidy)$statistic[[1]]
                DF_loop$P_val       <- map_df(list(Wilcoxmod), tidy)$p.value[[1]]
                DF_loop$SigDif      <- if( (map_df(list(Wilcoxmod), tidy)$p.value[[1]]) > 0.05) {
                  'NO'} else {'YES'}  
                DF_loop$Effsize     <- signif(eff_size_wilcox$effsize[[1]], 3)

              }
                  DF_loop$Age_DPF     <- GROUPvar_loop
                  # asign loop and cumulative output table
                  df                        <- data.frame(DF_loop) # name dataframe for this single row
                  outputfilename <- rbind(outputfilename,DF_loop) #bind to a cumulative list dataframe
                  # print(outputfilename) # print to monitor progress
                  
                }
return(outputfilename)
}

```


```{r standard shell size exploration}
plot(F1_dryweights_calc$Shell_length_mm, F1_dryweights_calc$Total_Dry_Tissue_g) + abline(h=1, col="blue") + abline(v=40, col="blue")

F1_dryweights_calc %>% 
  tidyr::drop_na(Dry_Gonad_weight_g) %>% 
  dplyr::filter(!(Total_Dry_Tissue_g < 0.125 & Shell_length_mm > 25)) %>% 
  ggplot(aes(Shell_length_mm,Total_Dry_Tissue_g, group = pH))+ 
    xlim(0,50)+
    ylim(0,1.2)+
    geom_point()+
    stat_smooth(method = "lm", formula = y ~ -1 + x + I(x^2), size = 1) + # -1 forces the y intercept as (0,0)
    stat_poly_eq(parse=T, aes(label = ..eq.label..), formula=y ~ -1 + x + I(x^2)) + # -1 forces the y intercept as (0,0)
    #geom_smooth(method = "lm", se=FALSE, aes(group=1, colour ="loess"),size=0.8) + 
  geom_hline(yintercept=1, color="blue", size=1) + 
  geom_vline(xintercept=40, color="blue", size=1) + 
  theme_bw() +
  facet_wrap(~pCO2)
  


```


# Dry Gonad: b factor calc and plot
```{r Gonad b factor calc and plot}
# b factor for gonad? 
LogDryGonadvShell <- F1_dryweights_calc.long.MEANS_master %>% 
                          dplyr::filter(measurement %in% c('Dry_Gonad_weight_g', 'Shell_length_mm')) %>%
                          # dplyr::group_by(measurement) %>% 
                          tidyr::pivot_wider(
                                              names_from = measurement,
                                              values_from = value
                          ) %>% 
                          # dplyr::select(-row) %>% 
                          dplyr::group_by(Age, pCO2, Tank_Replicate) %>%    
                          dplyr::mutate(log10_Gonad   = log10(Dry_Gonad_weight_g),
                                        log10_Length = log10(Shell_length_mm)) %>% 
                          na.omit() %>% # we only have gonad for later life stage - omit rows without it
                          dplyr::filter(!log10_Gonad %in% '-Inf') # ommit instances when gonad weight == 0
# View(LogDryGonadvShell)

# nrow(LogDryGonadvShell)
bfactorGonad.Length.pCO2 <- LogDryGonadvShell %>% ggplot(aes(x=log10_Length, y=log10_Gonad, color = pCO2)) +
                          geom_point() +
                          ggpmisc::stat_ma_line(method = "SMA") + # model 2 regression Standard major axis!
                          ggpmisc::stat_ma_eq(use_label(c("eq", "n", "R2"))) +
                          theme(panel.grid.major = element_blank(), 
                                      panel.grid.minor = element_blank())+ 
                             scale_colour_manual(breaks=c("500 μatm", "800 μatm"), 
                                             values=c("forestgreen","darkorange2")) +
                             scale_x_continuous(name ="log10_Length; in mm") +
                             scale_y_continuous(name ="log10_Gonad; RR in umol L-1 hr-1)") +
                             theme_classic() +
                             theme(legend.position="none",axis.title.y=element_text(size=7)) +
                             ggtitle("Gonad scaling: log10_Gonad = log10_a + 
                                      (b.factor * log10_Length)") +
                             # geom_smooth(method = lm, color = 'red') +
                             # ggpmisc::stat_poly_eq(method = "SMA",
                             #                       parse=T, 
                             #                       aes(label = paste(..eq.label.., ..rr.label.., 
                             #                                       sep = "~~~")),
                             #                          label.x.npc = "left") +
                             facet_wrap(~pCO2)


bfactorGonad.Length.all <- LogDryGonadvShell %>% ggplot(aes(x=log10_Length, y=log10_Gonad)) +
                          geom_point() +
                          ggpmisc::stat_ma_line(method = "SMA") + # model 2 regression Standard major axis!
                          ggpmisc::stat_ma_eq(use_label(c("eq", "n", "R2"))) +
                          theme(panel.grid.major = element_blank(), 
                                      panel.grid.minor = element_blank())+ 
                             scale_x_continuous(name ="log10_Length; in mm") +
                             scale_y_continuous(name ="log10_Gonad; RR in umol L-1 hr-1)") +
                             theme_classic() +
                             theme(legend.position="none",axis.title.y=element_text(size=7)) +
                             ggtitle("Gonad scaling: log10_Gonad = log10_a + 
                                      (b.factor * log10_Length)") 




# library(lsmeans)
m.interaction <- lm(log10_Length ~ log10_Gonad*pCO2, data = LogDryGonadvShell)
anova(m.interaction)
#                   Df Sum Sq Mean Sq F value   Pr(>F)    
# log10_Length       1 3.7135  3.7135 83.7209 6.31e-11 ***
# pCO2               1 0.1028  0.1028  2.3169   0.1367    
# log10_Length:pCO2  1 0.0354  0.0354  0.7985   0.3775    
# Residuals         36 1.5968  0.0444

# Obtain slopes
m.interaction$coefficients
m.lst <- lstrends(m.interaction, "pCO2", var="log10_Gonad")
# pCO2     log10_Gonad.trend     SE df lower.CL upper.CL
#  500 μatm             0.195 0.0353 36    0.123    0.267
#  800 μatm             0.230 0.0311 36    0.167    0.293

# Compare slopes
pairs(m.lst)
# contrast            estimate     SE df t.ratio p.value
#  500 μatm - 800 μatm  -0.0352 0.0471 36  -0.747  0.4600

# call dataset - omit data without gonad weights
F1_DryGonad <- F1_dryweights_calc %>% 
    dplyr::select(Age, pCO2, Tank_Replicate, Dry_Gonad_weight_g, Shell_length_mm) %>% 
    na.omit()
# call the mean gonad dry weight
meanLength.all <- mean(as.numeric((F1_DryGonad %>% dplyr::filter(!Dry_Gonad_weight_g  == 0))$Shell_length_mm))# 29.91838
seLength.all   <- sd(F1_DryGonad$Shell_length_mm)/sqrt(length((F1_DryGonad$Shell_length_mm))) # 0.4576706

StandardShellSize = 40

# age range of animals 
print(paste0('youngest = ', min(F1_DryGonad$Age), '; oldest = ', max(F1_DryGonad$Age)))

#assign bfactors
bLength.all <-  4.62 #mean data by rep tank # 6.89 - will all data
bLength.low <-  4.98 #mean data by rep tank # 6.99 - with all data
bLength.mod <-  4.29 #mean data by rep tank # 6.57 - with all data


# standardize gonad dry weight using bfactors
## follow the equation for scaling weights to length inbivalves 
### a = (weight of indiv / (height of indivisual)^bfactor )
### standardized weight == [a * (standard height)^bfactor ] *100
### /note: stnadard height is the mean of all individuals measured
F1_DryGonad.bfactor <- F1_DryGonad %>% 
                          dplyr::mutate(
                            # Gonad_bFactorLength.all_EQ = ( (Dry_Gonad_weight_g / (Shell_length_mm^bLength.all) )*100 ),
                           Gonad_bFactorLength.all  =  ( (Dry_Gonad_weight_g * (Shell_length_mm^-bLength.all)) * # == a,  mass index Bonardelli and Himmelman 1995 
                                                                    (StandardShellSize^bLength.all) )*100, # multiplied by the mean length as the standard raised to the b factor
                           Gonad_bFactorLength.pCO2 =  case_when(pCO2 == '500 μatm' ~
                                                                  ( (Dry_Gonad_weight_g * (Shell_length_mm^-bLength.low)) * # == a,  mass index Bonardelli and Himmelman 1995
                                                                      (StandardShellSize^bLength.low) )*100, # multiplied by the mean length as the standard raised to the b factor
                                                                 pCO2 == '800 μatm' ~ 
                                                                  ( (Dry_Gonad_weight_g * (Shell_length_mm^-bLength.mod))* # == a,  mass index Bonardelli and Himmelman 1995
                                                                      (StandardShellSize^bLength.mod) )*100 # multiplied by the mean length as the standard raised to the b factor
                           ) # case when for pCO2 
                          ) # mutate
# pivot longer and plot 
F1_DryGonad.bfactor.long <- F1_DryGonad.bfactor %>% 
                              dplyr::select(-Shell_length_mm) %>% 
                              tidyr::pivot_longer(
                                cols = c(Dry_Gonad_weight_g, Gonad_bFactorLength.all, Gonad_bFactorLength.pCO2),
                                names_to = "measurement",
                                values_to = "value"
                              )
# means by replicate tank 
F1_DryGonad.bfactor.long.MEANS <- F1_DryGonad.bfactor.long %>% 
                                    summarySE(measurevar="value", 
                                               groupvars=c("Age","pCO2", "Tank_Replicate", "measurement")) %>% 
                                    dplyr::arrange(as.numeric(Age))
# mmeans master - median for E-H as A-D!
F1_DryGonad.bfactor.long.MEANS_master <- F1_DryGonad.bfactor.long.MEANS %>%  # noew convert and resummarize by tank
                        dplyr::mutate(Tank_Replicate = case_when(
                                      Tank_Replicate == 'E' ~ 'A', #convert E to A
                                      Tank_Replicate == 'F' ~ 'B', #convert F to B
                                      Tank_Replicate == 'G' ~ 'C', #convert G to C
                                      Tank_Replicate == 'H' ~ 'D', #convert H to D
                                      .default = (as.character(Tank_Replicate)) # for cases A-D, keep em my mans
                                    )) %>% 
                        summarySE(measurevar="value", 
                                  groupvars=c("Age","pCO2", "Tank_Replicate", "measurement")) %>% # summarize again
                        dplyr::arrange(as.numeric(Age), measurement, pCO2, Tank_Replicate)
  
# 
Gonad_bfactor.MeanSE <-ggplot(F1_DryGonad.bfactor.long.MEANS_master,
                                 aes(x=factor(Age), 
                                     y=value, 
                                     colour=factor(pCO2)),
                                      stat="identity") +
                           scale_colour_manual(breaks=c("500 μatm", "800 μatm"), 
                                             values=c("forestgreen","darkorange2")) +
                           geom_point(aes(colour = pCO2), 
                                            position = position_dodge2(width = 0.5)) + 
                           stat_summary(fun.y="mean", size = 0.8,
                                              position = position_dodge2(width = 0.5)) +
                           stat_summary(fun.min = function(x) mean(x) - sd(x)/sqrt(length(x)), 
                                              fun.max = function(x) mean(x) + sd(x)/sqrt(length(x)),
                                              geom = 'errorbar', width = 0.25, size = 1,
                                              position = position_dodge2(width = 0.5)) + 
                           labs(title="Mean + SE data", 
                                                      x ="Age (dpf)", 
                                                      y = "value") +
                          # scale_y_continuous(expand = c(0, 0), limits = c(0, NA)) +
                          theme_classic() +
                          theme(panel.grid.major = element_blank(), 
                                panel.grid.minor = element_blank(), 
                                # axis.title.y=element_blank(),
                                # axis.title.x=element_blank(),
                                axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=1),
                                axis.text=element_text(size=8),
                                plot.title = element_text(size=12),
                                legend.position="none") +
                          facet_wrap(~measurement, scales = "free_y")


pdf("Output/DryWeights/F1/length_scaling/Dry_Gonad_byLength.pdf", height=8, width =8)
ggarrange(bfactorGonad.Length.all, bfactorGonad.Length.pCO2,Gonad_bfactor.MeanSE, nrow=3)
dev.off()



Gonad_final_plot <- F1_DryGonad.bfactor.long.MEANS_master %>% 
                          dplyr::filter(measurement %in% 'Gonad_bFactorLength.pCO2') %>% 
                          ggplot(aes(x=factor(Age), y=value, colour=factor(pCO2)),stat="identity") +
                           scale_colour_manual(breaks=c("500 μatm", "800 μatm"), 
                                                        values=c("forestgreen","darkorange2")) +
                          stat_summary(fun.y="mean", size = 0.8,
                                        position = position_dodge2(width = 0.25)) +
                          stat_summary(fun.min = function(x) mean(x) - sd(x)/sqrt(length(x)), 
                                        fun.max = function(x) mean(x) + sd(x)/sqrt(length(x)),
                                        geom = 'errorbar', width = 0.25, size = 1,
                                        position = position_dodge2(width = 0.5)) + 
                          labs(title="Gonad: Length b factor pCO2", x ="Age (dpf)", y = "Dry gonad (mg Lengthbfactor_pCO2)") +
                          theme_classic() +
                          theme(panel.grid.major = element_blank(), 
                                panel.grid.minor = element_blank(), 
                                axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=1),
                                axis.text=element_text(size=8),
                                plot.title = element_text(size=12),
                                legend.position="none")

```

# Dry Gonad stats
```{r Gonad Stats raw - no standardization}

F1_DryGonad.raw.MEAN <- F1_DryGonad.bfactor.long.MEANS_master %>% 
                                dplyr::filter(measurement %in% 'Dry_Gonad_weight_g')
F1_DryGonad.raw.MEAN$DPvar    <- F1_DryGonad.raw.MEAN$value
F1_DryGonad.raw.MEAN$INDvar   <- F1_DryGonad.raw.MEAN$pCO2
F1_DryGonad.raw.MEAN$GROUPvar <- F1_DryGonad.raw.MEAN$Age

Stats_GonadMEAN_raw <- as.data.frame(runstats(F1_DryGonad.raw.MEAN))
Ttest_GonadMEAN_raw <- as.data.frame(run_ttest(F1_DryGonad.raw.MEAN))
# About column
Stats_GonadMEAN_raw$About <- paste0("Gonad: raw, NO BFACTOR + mean data")
Ttest_GonadMEAN_raw$About <- paste0("Gonad: raw, NO BFACTOR + mean data")

```

```{r Mean Gonad Stats bfactor all - length standardized}

F1_DryGonad.bfactor.MEAN <- F1_DryGonad.bfactor.long.MEANS_master %>% 
                                dplyr::filter(measurement %in% 'Gonad_bFactorLength.all')
F1_DryGonad.bfactor.MEAN$DPvar    <- F1_DryGonad.bfactor.MEAN$value
F1_DryGonad.bfactor.MEAN$INDvar   <- F1_DryGonad.bfactor.MEAN$pCO2
F1_DryGonad.bfactor.MEAN$GROUPvar <- F1_DryGonad.bfactor.MEAN$Age

Stats_GonadMEAN_bfactor.all <- as.data.frame(runstats(F1_DryGonad.bfactor.MEAN))
Ttest_GonadMEAN_bfactor.all <- as.data.frame(run_ttest(F1_DryGonad.bfactor.MEAN))
# About column
Stats_GonadMEAN_bfactor.all$About <- paste0("Gonad: one bfactor + mean data")
Ttest_GonadMEAN_bfactor.all$About <- paste0("Gonad: one bfactor + mean data")

```

```{r Mean Gonad Stats bfactor pCO2 - length standardized}

# means by replicate tank within treamtent and day/age
F1_DryGonad.bfactor.MEAN <- F1_DryGonad.bfactor.long.MEANS_master %>% 
                                dplyr::filter(measurement %in% 'Gonad_bFactorLength.pCO2')
F1_DryGonad.bfactor.MEAN$DPvar    <- F1_DryGonad.bfactor.MEAN$value
F1_DryGonad.bfactor.MEAN$INDvar   <- F1_DryGonad.bfactor.MEAN$pCO2
F1_DryGonad.bfactor.MEAN$GROUPvar <- F1_DryGonad.bfactor.MEAN$Age

Stats_GonadMEAN_bfactor.pCO2 <- as.data.frame(runstats(F1_DryGonad.bfactor.MEAN))
Ttest_GonadMEAN_bfactor.pCO2 <- as.data.frame(run_ttest(F1_DryGonad.bfactor.MEAN))
# About column
Stats_GonadMEAN_bfactor.pCO2$About <- paste0("Gonad: two pCO2 bfactors + mean data")
Ttest_GonadMEAN_bfactor.pCO2$About <- paste0("Gonad: two pCO2 bfactors + mean data")
```

* merge all Gonad stats, save
```{r}

GonadMaster_stats <- rbind(Stats_GonadMEAN_raw, Stats_GonadMEAN_bfactor.all, Stats_GonadMEAN_bfactor.pCO2)

write.csv(GonadMaster_stats, "Output/DryWeights/F1/F1_Gonad_DryWeight_ANOVA_table.csv")

GonadMaster_Ttest <- rbind(Ttest_GonadMEAN_raw, Ttest_GonadMEAN_bfactor.all, Ttest_GonadMEAN_bfactor.pCO2)
write.csv(GonadMaster_Ttest, "Output/DryWeights/F1/F1_Gonad_DryWeight_Ttest_table.csv")

```






# Dry Adductor: b factor calc and plot
```{r Adductor b factor calc and plot}
# b factor for adductor? 
LogDryAdductorvShell <- F1_dryweights_calc.long.MEANS_master %>% 
                          dplyr::filter(measurement %in% c('Dry_Adductor_Tissue_g', 'Shell_length_mm')) %>%
                          # dplyr::group_by(measurement) %>% 
                          tidyr::pivot_wider(
                                              names_from = measurement,
                                              values_from = value
                          ) %>% 
                          # dplyr::select(-row) %>% 
                          dplyr::group_by(Age, pCO2, Tank_Replicate) %>%    
                          dplyr::mutate(log10_Adductor   = log10(Dry_Adductor_Tissue_g),
                                        log10_Length = log10(Shell_length_mm)) %>% 
                          na.omit() %>% # we only have adductor for later life stage - omit rows without it
                          dplyr::filter(!log10_Adductor %in% '-Inf') # ommit instances when adductor weight == 0

bfactorAdductor.Length.pCO2 <- LogDryAdductorvShell %>% ggplot(aes(x=log10_Length, y=log10_Adductor, color = pCO2)) +
                          geom_point() +
                          ggpmisc::stat_ma_line(method = "SMA") + # model 2 regression Standard major axis!
                          ggpmisc::stat_ma_eq(use_label(c("eq", "n", "R2"))) +
                          theme(panel.grid.major = element_blank(), 
                                      panel.grid.minor = element_blank())+ 
                             scale_colour_manual(breaks=c("500 μatm", "800 μatm"), 
                                             values=c("forestgreen","darkorange2")) +
                             scale_x_continuous(name ="log10_Length; in mm") +
                             scale_y_continuous(name ="log10_Adductor; in g)") +
                             theme_classic() +
                             theme(legend.position="none",axis.title.y=element_text(size=7)) +
                             ggtitle("Adductor scaling: log10_adductor = log10_a + 
                                      (b.factor * log10_Length)") +
                             # geom_smooth(method = lm, color = 'red') +
                             # ggpmisc::stat_poly_eq(parse=T, 
                             #                       aes(label = paste(..eq.label.., ..rr.label.., 
                             #                                       sep = "~~~")),
                             #                          label.x.npc = "left") +
                             facet_wrap(~pCO2)


bfactorAdductor.Length.all <- LogDryAdductorvShell %>% ggplot(aes(x=log10_Length, y=log10_Adductor)) +
                          geom_point() +
                          ggpmisc::stat_ma_line(method = "SMA") + # model 2 regression Standard major axis!
                          ggpmisc::stat_ma_eq(use_label(c("eq", "n", "R2"))) +
                          theme(panel.grid.major = element_blank(), 
                                theme(panel.grid.major = element_blank(), 
                                      panel.grid.minor = element_blank())) + 
                             scale_x_continuous(name ="log10_Length; in mm") +
                             scale_y_continuous(name ="log10_Adductor; in g") +
                             theme_classic() +
                             theme(legend.position="none",axis.title.y=element_text(size=7)) +
                             ggtitle("adductor scaling: log10_adductor = log10_a + 
                                      (b.factor * log10_Length)") #+
                             # geom_smooth(method = lm, color = 'red') +
                             # ggpmisc::stat_poly_eq(parse=T, 
                             #                       aes(label = paste(..eq.label.., ..rr.label.., 
                             #                                       sep = "~~~")),
                             #                          label.x.npc = "left") 

# call dataset - omit data without adductor weights
F1_DryAdductor <- F1_dryweights_calc %>% 
    dplyr::select(Age, pCO2, Tank_Replicate, Dry_Adductor_Tissue_g, Shell_length_mm) %>% 
    na.omit()
# call the mean adductor dry weight
meanLength.all <- mean(F1_DryAdductor$Shell_length_mm) # 27.44867
seLength.all   <- sd(F1_DryAdductor$Shell_length_mm)/sqrt(length((F1_DryAdductor$Shell_length_mm))) # 0.5550621

StandardShellSize = 40
# age range of animals 
print(paste0('youngest = ', min(F1_DryAdductor$Age), '; oldest = ', max(F1_DryAdductor$Age)))
#assign bfactors
bLength.all <- 3.19#3.04 using all data
bLength.low <- 3.25#3.02 using all data
bLength.mod <- 3.07#3.09 using all data


# standardize adductor dry weight using bfactors
F1_DryAdductor.bfactor <- F1_DryAdductor %>% 
                          dplyr::mutate(
                           Adductor_bFactorLength.all  =  ( (Dry_Adductor_Tissue_g * (Shell_length_mm^-bLength.all))* # a
                                                                    (StandardShellSize^bLength.all) ) * 100,
                           Adductor_bFactorLength.pCO2 =  case_when(pCO2 == '500 μatm' ~
                                                                   ( (Dry_Adductor_Tissue_g * (Shell_length_mm^-bLength.low))* # a
                                                                      (StandardShellSize^bLength.low) ) * 100,
                                                                 pCO2 == '800 μatm' ~ 
                                                                   ( (Dry_Adductor_Tissue_g * (Shell_length_mm^-bLength.mod))* # a
                                                                      (StandardShellSize^bLength.mod) ) * 100
                           ) # case when for pCO2 
                          ) # mutate
# pivot longer and plot 
F1_DryAdductor.bfactor.long <- F1_DryAdductor.bfactor %>% 
                              dplyr::select(-Shell_length_mm) %>% 
                              tidyr::pivot_longer(
                                cols = c(Dry_Adductor_Tissue_g, Adductor_bFactorLength.all, Adductor_bFactorLength.pCO2),
                                names_to = "measurement",
                                values_to = "value"
                              )
# means by replicate tank 
F1_DryAdductor.bfactor.long.MEANS <- F1_DryAdductor.bfactor.long %>% 
                                    summarySE(measurevar="value", 
                                               groupvars=c("Age","pCO2", "Tank_Replicate", "measurement")) %>% 
                                    dplyr::arrange(as.numeric(Age))
# mmeans master - median for E-H as A-D!
F1_DryAdductor.bfactor.long.MEANS_master <- F1_DryAdductor.bfactor.long.MEANS %>%  # noew convert and resummarize by tank
                        dplyr::mutate(Tank_Replicate = case_when(
                                      Tank_Replicate == 'E' ~ 'A', #convert E to A
                                      Tank_Replicate == 'F' ~ 'B', #convert F to B
                                      Tank_Replicate == 'G' ~ 'C', #convert G to C
                                      Tank_Replicate == 'H' ~ 'D', #convert H to D
                                      .default = (as.character(Tank_Replicate)) # for cases A-D, keep em my mans
                                    )) %>% 
                        summarySE(measurevar="value", 
                                  groupvars=c("Age","pCO2", "Tank_Replicate", "measurement")) %>% # summarize again
                        dplyr::arrange(as.numeric(Age), measurement, pCO2, Tank_Replicate)
  
Adductor_bfactor.MeanSE <-ggplot(F1_DryAdductor.bfactor.long.MEANS_master,
                                 aes(x=factor(Age), 
                                     y=value, 
                                     colour=factor(pCO2)),
                                      stat="identity") +
                           scale_colour_manual(breaks=c("500 μatm", "800 μatm"), 
                                             values=c("forestgreen","darkorange2")) +
                           geom_point(aes(colour = pCO2), 
                                            position = position_dodge2(width = 0.5)) + 
                           stat_summary(fun.y="mean", size = 0.8,
                                              position = position_dodge2(width = 0.5)) +
                           stat_summary(fun.min = function(x) mean(x) - sd(x)/sqrt(length(x)), 
                                              fun.max = function(x) mean(x) + sd(x)/sqrt(length(x)),
                                              geom = 'errorbar', width = 0.25, size = 1,
                                              position = position_dodge2(width = 0.5)) + 
                           labs(title="Mean + SE data", 
                                                      x ="Age (dpf)", 
                                                      y = "value") +
                          # scale_y_continuous(expand = c(0, 0), limits = c(0, NA)) +
                          theme_classic() +
                          theme(panel.grid.major = element_blank(), 
                                panel.grid.minor = element_blank(), 
                                # axis.title.y=element_blank(),
                                # axis.title.x=element_blank(),
                                axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=1),
                                axis.text=element_text(size=8),
                                plot.title = element_text(size=12),
                                legend.position="none") +
                          facet_wrap(~measurement, scales = "free_y")


pdf("Output/DryWeights/F1/length_scaling/Dry_Adductor_byLength.pdf", height=8, width =8)
ggarrange(bfactorAdductor.Length.all, bfactorAdductor.Length.pCO2,Adductor_bfactor.MeanSE, nrow=3)
dev.off()


Adductor_final_plot <- F1_DryAdductor.bfactor.long.MEANS_master %>% 
                          dplyr::filter(measurement %in% 'Adductor_bFactorLength.pCO2') %>% 
                          ggplot(aes(x=factor(Age), y=value, colour=factor(pCO2)),stat="identity") +
                          # geom_jitter(shape = 4) +
                          scale_colour_manual(breaks=c("500 μatm", "800 μatm"), 
                                                        values=c("forestgreen","darkorange2")) +
                          stat_summary(fun.y="mean", size = 0.8,
                                        position = position_dodge2(width = 0.25)) +
                          stat_summary(fun.min = function(x) mean(x) - sd(x)/sqrt(length(x)), 
                                        fun.max = function(x) mean(x) + sd(x)/sqrt(length(x)),
                                        geom = 'errorbar', width = 0.25, size = 1,
                                        position = position_dodge2(width = 0.5)) + 
                          labs(title="Adductor: Length b factor pCO2", x ="Age (dpf)", 
                               y = "Dry adductor (mg bFactorLength.pCO2)") +
                          theme_classic() +
                          theme(panel.grid.major = element_blank(), 
                                panel.grid.minor = element_blank(), 
                                axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=1),
                                axis.text=element_text(size=8),
                                plot.title = element_text(size=12),
                                legend.position="none")
```

# Dry Adductor stats
```{r Adductor Stats raw - no standardization}

F1_DryAdductor.raw.MEAN <- F1_DryAdductor.bfactor.long.MEANS_master %>% 
                                dplyr::filter(measurement %in% 'Dry_Adductor_Tissue_g')
F1_DryAdductor.raw.MEAN$DPvar    <- F1_DryAdductor.raw.MEAN$value
F1_DryAdductor.raw.MEAN$INDvar   <- F1_DryAdductor.raw.MEAN$pCO2
F1_DryAdductor.raw.MEAN$GROUPvar <- F1_DryAdductor.raw.MEAN$Age

Stats_AdductorMEAN_raw <- as.data.frame(runstats(F1_DryAdductor.raw.MEAN))
Ttest_AdductorMEAN_raw <- as.data.frame(run_ttest(F1_DryAdductor.raw.MEAN))
# About column
Stats_AdductorMEAN_raw$About <- paste0("Adductor: raw, NO BFACTOR + mean data")
Ttest_AdductorMEAN_raw$About <- paste0("Adductor: raw, NO BFACTOR + mean data")
```

```{r Mean Adductor Stats bfactor all - length standardized}

F1_DryAdductor.bfactor.MEAN <- F1_DryAdductor.bfactor.long.MEANS_master %>% 
                                dplyr::filter(measurement %in% 'Adductor_bFactorLength.all')
F1_DryAdductor.bfactor.MEAN$DPvar    <- F1_DryAdductor.bfactor.MEAN$value
F1_DryAdductor.bfactor.MEAN$INDvar   <- F1_DryAdductor.bfactor.MEAN$pCO2
F1_DryAdductor.bfactor.MEAN$GROUPvar <- F1_DryAdductor.bfactor.MEAN$Age

Stats_AdductorMEAN_bfactor.all <- as.data.frame(runstats(F1_DryAdductor.bfactor.MEAN))
Ttest_AdductorMEAN_bfactor.all <- as.data.frame(run_ttest(F1_DryAdductor.bfactor.MEAN))

# About column
Stats_AdductorMEAN_bfactor.all$About <- paste0("Adductor: one bfactor + mean data")
Ttest_AdductorMEAN_bfactor.all$About <- paste0("Adductor: one bfactor + mean data")

```

```{r Mean Adductor Stats bfactor pCO2 - length standardized}

# means by replicate tank within treamtent and day/age
F1_DryAdductor.bfactor.MEAN <- F1_DryAdductor.bfactor.long.MEANS_master %>% 
                                dplyr::filter(measurement %in% 'Adductor_bFactorLength.pCO2')
F1_DryAdductor.bfactor.MEAN$DPvar    <- F1_DryAdductor.bfactor.MEAN$value
F1_DryAdductor.bfactor.MEAN$INDvar   <- F1_DryAdductor.bfactor.MEAN$pCO2
F1_DryAdductor.bfactor.MEAN$GROUPvar <- F1_DryAdductor.bfactor.MEAN$Age

Stats_AdductorMEAN_bfactor.pCO2 <- as.data.frame(runstats(F1_DryAdductor.bfactor.MEAN))
Ttest_AdductorMEAN_bfactor.pCO2 <- as.data.frame(run_ttest(F1_DryAdductor.bfactor.MEAN))

# About column
Stats_AdductorMEAN_bfactor.pCO2$About <- paste0("Adductor: two pCO2 bfactors + mean data")
Ttest_AdductorMEAN_bfactor.pCO2$About <- paste0("Adductor: two pCO2 bfactors + mean data")

```

* merge all Adductor stats, save
```{r}

AdductorMaster_stats <- rbind(Stats_AdductorMEAN_raw, Stats_AdductorMEAN_bfactor.all, Stats_AdductorMEAN_bfactor.pCO2)

write.csv(AdductorMaster_stats, "Output/DryWeights/F1/F1_Adductor_DryWeight_ANOVA_table.csv")

AdductorMaster_Ttest <- rbind(Ttest_AdductorMEAN_raw, Ttest_AdductorMEAN_bfactor.all, Ttest_AdductorMEAN_bfactor.pCO2)

write.csv(AdductorMaster_Ttest, "Output/DryWeights/F1/F1_Adductor_DryWeight_Ttest_table.csv")

```






# Dry Somatic: b factor calc and plot
```{r Somatic b factor calc and plot}
# b factor for Somatic? 
LogDrySomaticvShell <- F1_dryweights_calc.long.MEANS_master %>% 
                          dplyr::filter(measurement %in% c('Dry_Somatic_Tissue_g', 'Shell_length_mm')) %>%
                          # dplyr::group_by(measurement) %>% 
                          tidyr::pivot_wider(
                                              names_from = measurement,
                                              values_from = value
                          ) %>% 
                          # dplyr::select(-row) %>% 
                          dplyr::group_by(Age, pCO2, Tank_Replicate) %>%    
                          dplyr::mutate(log10_Somatic   = log10(Dry_Somatic_Tissue_g),
                                        log10_Length = log10(Shell_length_mm)) %>% 
                          na.omit() %>% # we only have somatic for later life stage - omit rows without it
                          dplyr::filter(!log10_Somatic %in% '-Inf') # ommit instances when somatic weight == 0

bfactorSomatic.Length.pCO2 <- LogDrySomaticvShell %>% ggplot(aes(x=log10_Length, y=log10_Somatic, color = pCO2)) +
                          geom_point() +
                          ggpmisc::stat_ma_line(method = "SMA") + # model 2 regression Standard major axis!
                          ggpmisc::stat_ma_eq(use_label(c("eq", "n", "R2"))) +
                          theme(panel.grid.major = element_blank(), 
                                      panel.grid.minor = element_blank())+ 
                             scale_colour_manual(breaks=c("500 μatm", "800 μatm"), 
                                             values=c("forestgreen","darkorange2")) +
                             scale_x_continuous(name ="log10_Length; in mm") +
                             scale_y_continuous(name ="log10_Somatic; in g)") +
                             theme_classic() +
                             theme(legend.position="none",axis.title.y=element_text(size=7)) +
                             ggtitle("Somatic scaling: log10_Somatic = log10_a + 
                                      (b.factor * log10_Length)") +
                             geom_smooth(method = lm, color = 'red') +
                             # ggpmisc::stat_poly_eq(parse=T, 
                             #                       aes(label = paste(..eq.label.., ..rr.label.., 
                             #                                       sep = "~~~")),
                             #                          label.x.npc = "left") +
                             facet_wrap(~pCO2)


bfactorSomatic.Length.all <- LogDrySomaticvShell %>% ggplot(aes(x=log10_Length, y=log10_Somatic)) +
                          geom_point() +
                          ggpmisc::stat_ma_line(method = "SMA") + # model 2 regression Standard major axis!
                          ggpmisc::stat_ma_eq(use_label(c("eq", "n", "R2"))) +
                          theme(panel.grid.major = element_blank(), 
                                      panel.grid.minor = element_blank())+ 
                             scale_x_continuous(name ="log10_Length; in mm") +
                             scale_y_continuous(name ="log10_Somatic; in g") +
                             theme_classic() +
                             theme(legend.position="none",axis.title.y=element_text(size=7)) +
                             ggtitle("Somatic scaling: log10_Somatic = log10_a + 
                                      (b.factor * log10_Length)")# +
                             # geom_smooth(method = lm, color = 'red') +
                             # ggpmisc::stat_poly_eq(parse=T, 
                             #                       aes(label = paste(..eq.label.., ..rr.label.., 
                             #                                       sep = "~~~")),
                             #                          label.x.npc = "left") 

# call dataset - omit data without Somatic weights
F1_DrySomatic <- F1_dryweights_calc %>% 
    dplyr::select(Age, pCO2, Tank_Replicate, Dry_Somatic_Tissue_g, Shell_length_mm) %>% 
    na.omit()
# call the mean Somatic dry weight
meanLength.all <- mean(F1_DrySomatic$Shell_length_mm) # 27.44867
seLength.all   <- sd(F1_DrySomatic$Shell_length_mm)/sqrt(length((F1_DrySomatic$Shell_length_mm))) # 0.5550621

StandardShellSize = 40
# age range of animals 
print(paste0('youngest = ', min(F1_DrySomatic$Age), '; oldest = ', max(F1_DrySomatic$Age)))
#assign bfactors
bLength.all <- 3.25 #2.96 
bLength.low <- 3.27 #2.97
bLength.mod <- 3.23 #2.97
# standardize Somatic dry weight using bfactors
F1_DrySomatic.bfactor <- F1_DrySomatic %>% 
                          dplyr::mutate(
                           Somatic_bFactorLength.all  =  ( (Dry_Somatic_Tissue_g * (Shell_length_mm^-bLength.all))* # a
                                                                    (StandardShellSize^bLength.all) ) * 100,
                           Somatic_bFactorLength.pCO2 =  case_when(pCO2 == '500 μatm' ~
                                                                   ( (Dry_Somatic_Tissue_g * (Shell_length_mm^-bLength.low))* # a
                                                                      (StandardShellSize^bLength.low) ) * 100,
                                                                 pCO2 == '800 μatm' ~ 
                                                                   ( (Dry_Somatic_Tissue_g * (Shell_length_mm^-bLength.mod))* # a
                                                                      (StandardShellSize^bLength.mod) ) * 100
                           ) # case when for pCO2 
                          ) # mutate
# pivot longer and plot 
F1_DrySomatic.bfactor.long <- F1_DrySomatic.bfactor %>% 
                              dplyr::select(-Shell_length_mm) %>% 
                              tidyr::pivot_longer(
                                cols = c(Dry_Somatic_Tissue_g, Somatic_bFactorLength.all, Somatic_bFactorLength.pCO2),
                                names_to = "measurement",
                                values_to = "value"
                              )
# means by replicate tank 
F1_DrySomatic.bfactor.long.MEANS <- F1_DrySomatic.bfactor.long %>% 
                                    summarySE(measurevar="value", 
                                               groupvars=c("Age","pCO2", "Tank_Replicate", "measurement")) %>% 
                                    dplyr::arrange(as.numeric(Age))
# mmeans master - median for E-H as A-D!
F1_DrySomatic.bfactor.long.MEANS_master <- F1_DrySomatic.bfactor.long.MEANS %>%  # noew convert and resummarize by tank
                        dplyr::mutate(Tank_Replicate = case_when(
                                      Tank_Replicate == 'E' ~ 'A', #convert E to A
                                      Tank_Replicate == 'F' ~ 'B', #convert F to B
                                      Tank_Replicate == 'G' ~ 'C', #convert G to C
                                      Tank_Replicate == 'H' ~ 'D', #convert H to D
                                      .default = (as.character(Tank_Replicate)) # for cases A-D, keep em my mans
                                    )) %>% 
                        summarySE(measurevar="value", 
                                  groupvars=c("Age","pCO2", "Tank_Replicate", "measurement")) %>% # summarize again
                        dplyr::arrange(as.numeric(Age), measurement, pCO2, Tank_Replicate)

Somatic_bfactor.MeanSE <-ggplot(F1_DrySomatic.bfactor.long.MEANS_master,
                                 aes(x=factor(Age), 
                                     y=value, 
                                     colour=factor(pCO2)),
                                      stat="identity") +
                           scale_colour_manual(breaks=c("500 μatm", "800 μatm"), 
                                             values=c("forestgreen","darkorange2")) +
                           geom_point(aes(colour = pCO2), 
                                            position = position_dodge2(width = 0.5)) + 
                           stat_summary(fun.y="mean", size = 0.8,
                                              position = position_dodge2(width = 0.5)) +
                           stat_summary(fun.min = function(x) mean(x) - sd(x)/sqrt(length(x)), 
                                              fun.max = function(x) mean(x) + sd(x)/sqrt(length(x)),
                                              geom = 'errorbar', width = 0.25, size = 1,
                                              position = position_dodge2(width = 0.5)) + 
                           labs(title="Mean + SE data", 
                                                      x ="Age (dpf)", 
                                                      y = "value") +
                          # scale_y_continuous(expand = c(0, 0), limits = c(0, NA)) +
                          theme_classic() +
                          theme(panel.grid.major = element_blank(), 
                                panel.grid.minor = element_blank(), 
                                # axis.title.y=element_blank(),
                                # axis.title.x=element_blank(),
                                axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=1),
                                axis.text=element_text(size=8),
                                plot.title = element_text(size=12),
                                legend.position="none") +
                          facet_wrap(~measurement, scales = "free_y")


pdf("Output/DryWeights/F1/length_scaling/Dry_Somatic_byLength.pdf", height=8, width =8)
ggarrange(bfactorSomatic.Length.all, bfactorSomatic.Length.pCO2,Somatic_bfactor.MeanSE, nrow=3)
dev.off()


Somatic_final_plot <- F1_DrySomatic.bfactor.long.MEANS_master %>% 
                          dplyr::filter(measurement %in% 'Somatic_bFactorLength.pCO2') %>% 
                          ggplot(aes(x=factor(Age), y=value, colour=factor(pCO2)),stat="identity") +
                           scale_colour_manual(breaks=c("500 μatm", "800 μatm"), 
                                                        values=c("forestgreen","darkorange2")) +
                          stat_summary(fun.y="mean", size = 0.8,
                                        position = position_dodge2(width = 0.25)) +
                          stat_summary(fun.min = function(x) mean(x) - sd(x)/sqrt(length(x)), 
                                        fun.max = function(x) mean(x) + sd(x)/sqrt(length(x)),
                                        geom = 'errorbar', width = 0.25, size = 1,
                                        position = position_dodge2(width = 0.5)) + 
                          labs(title="Somatic: Length b factor pCO2", x ="Age (dpf)", y = "Dry Somatic (mg Lengthbfactor_pCO2)") +
                          theme_classic() +
                          theme(panel.grid.major = element_blank(), 
                                panel.grid.minor = element_blank(), 
                                axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=1),
                                axis.text=element_text(size=8),
                                plot.title = element_text(size=12),
                                legend.position="none")
```

# Dry Somatic stats
```{r Somatic Stats raw - no standardization}

F1_DrySomatic.raw.MEAN <- F1_DrySomatic.bfactor.long.MEANS_master %>% 
                                dplyr::filter(measurement %in% 'Dry_Somatic_Tissue_g')
F1_DrySomatic.raw.MEAN$DPvar    <- F1_DrySomatic.raw.MEAN$value
F1_DrySomatic.raw.MEAN$INDvar   <- F1_DrySomatic.raw.MEAN$pCO2
F1_DrySomatic.raw.MEAN$GROUPvar <- F1_DrySomatic.raw.MEAN$Age

Stats_SomaticMEAN_raw <- as.data.frame(runstats(F1_DrySomatic.raw.MEAN))
Ttest_SomaticMEAN_raw <- as.data.frame(run_ttest(F1_DrySomatic.raw.MEAN))

# About column
Stats_SomaticMEAN_raw$About <- paste0("Somatic: raw, NO BFACTOR + mean data")
Ttest_SomaticMEAN_raw$About <- paste0("Somatic: raw, NO BFACTOR + mean data")

```

```{r Mean Somatic Stats bfactor all - length standardized}

F1_DrySomatic.bfactor.MEAN <- F1_DrySomatic.bfactor.long.MEANS_master %>% 
                                dplyr::filter(measurement %in% 'Somatic_bFactorLength.all')
F1_DrySomatic.bfactor.MEAN$DPvar    <- F1_DrySomatic.bfactor.MEAN$value
F1_DrySomatic.bfactor.MEAN$INDvar   <- F1_DrySomatic.bfactor.MEAN$pCO2
F1_DrySomatic.bfactor.MEAN$GROUPvar <- F1_DrySomatic.bfactor.MEAN$Age

Stats_SomaticMEAN_bfactor.all <- as.data.frame(runstats(F1_DrySomatic.bfactor.MEAN))
Ttest_SomaticMEAN_bfactor.all <- as.data.frame(run_ttest(F1_DrySomatic.bfactor.MEAN))

# About column
Stats_SomaticMEAN_bfactor.all$About <- paste0("Somatic: one bfactor + mean data")
Ttest_SomaticMEAN_bfactor.all$About <- paste0("Somatic: one bfactor + mean data")

```

```{r Mean Somatic Stats bfactor pCO2 - length standardized}

# means by replicate tank within treamtent and day/age
F1_DrySomatic.bfactor.MEAN <- F1_DrySomatic.bfactor.long.MEANS_master %>% 
                                dplyr::filter(measurement %in% 'Somatic_bFactorLength.pCO2')
F1_DrySomatic.bfactor.MEAN$DPvar    <- F1_DrySomatic.bfactor.MEAN$value
F1_DrySomatic.bfactor.MEAN$INDvar   <- F1_DrySomatic.bfactor.MEAN$pCO2
F1_DrySomatic.bfactor.MEAN$GROUPvar <- F1_DrySomatic.bfactor.MEAN$Age

Stats_SomaticMEAN_bfactor.pCO2 <- as.data.frame(runstats(F1_DrySomatic.bfactor.MEAN))
Ttest_SomaticMEAN_bfactor.pCO2 <- as.data.frame(run_ttest(F1_DrySomatic.bfactor.MEAN))

# About column
Stats_SomaticMEAN_bfactor.pCO2$About <- paste0("Somatic: two pCO2 bfactors + mean data")
Ttest_SomaticMEAN_bfactor.pCO2$About <- paste0("Somatic: two pCO2 bfactors + mean data")

```

* merge all Somatic stats, save
```{r}

SomaticMaster_stats <- rbind(Stats_SomaticMEAN_raw, Stats_SomaticMEAN_bfactor.all, Stats_SomaticMEAN_bfactor.pCO2)

write.csv(SomaticMaster_stats, "Output/DryWeights/F1/F1_Somatic_DryWeight_ANOVA_table.csv")

SomaticMaster_Ttest <- rbind(Ttest_SomaticMEAN_raw, Ttest_SomaticMEAN_bfactor.all, Ttest_SomaticMEAN_bfactor.pCO2)

write.csv(SomaticMaster_Ttest, "Output/DryWeights/F1/F1_Somatic_DryWeight_Ttest_table.csv")
```






# Dry Shell: b factor calc and plot
```{r Shell b factor calc and plot}
# b factor for Shell? 
LogDryTissue <- F1_dryweights_calc.long.MEANS_master %>% 
                          dplyr::filter(measurement %in% c('Dry_Shell_weight_g', 'Shell_length_mm')) %>%
                          # dplyr::group_by(measurement) %>% 
                          tidyr::pivot_wider(
                                              names_from = measurement,
                                              values_from = value
                          ) %>% 
                          # dplyr::select(-row) %>% 
                          dplyr::group_by(Age, pCO2, Tank_Replicate) %>%    
                          dplyr::mutate(log10_Shell   = log10(Dry_Shell_weight_g),
                                        log10_Length = log10(Shell_length_mm)) %>% 
                          na.omit() %>% # we only have shell for later life stage - omit rows without it
                          dplyr::filter(!log10_Shell %in% '-Inf') # ommit instances when shell weight == 0

bfactorShell.Length.pCO2 <- LogDryTissue %>% ggplot(aes(x=log10_Length, y=log10_Shell, color = pCO2)) +
                          geom_point() +
                          ggpmisc::stat_ma_line(method = "SMA") + # model 2 regression Standard major axis!
                          ggpmisc::stat_ma_eq(use_label(c("eq", "n", "R2"))) +
                          theme(panel.grid.major = element_blank(), 
                                      panel.grid.minor = element_blank())+ 
                             scale_colour_manual(breaks=c("500 μatm", "800 μatm"), 
                                             values=c("forestgreen","darkorange2")) +
                             scale_x_continuous(name ="log10_Length; in mm") +
                             scale_y_continuous(name ="log10_Shell; in g)") +
                             theme_classic() +
                             theme(legend.position="none",axis.title.y=element_text(size=7)) +
                             ggtitle("Shell scaling: log10_Shell = log10_a + 
                                      (b.factor * log10_Length)") +
                             # geom_smooth(method = lm, color = 'red') +
                             # ggpmisc::stat_poly_eq(parse=T, 
                             #                       aes(label = paste(..eq.label.., ..rr.label.., 
                             #                                       sep = "~~~")),
                             #                          label.x.npc = "left") +
                             facet_wrap(~pCO2)


bfactorShell.Length.all <- LogDryTissue %>% ggplot(aes(x=log10_Length, y=log10_Shell)) +
                          geom_point() +
                          ggpmisc::stat_ma_line(method = "SMA") + # model 2 regression Standard major axis!
                          ggpmisc::stat_ma_eq(use_label(c("eq", "n", "R2"))) +
                          theme(panel.grid.major = element_blank(), 
                                      panel.grid.minor = element_blank())+ 
                             scale_x_continuous(name ="log10_Length; in mm") +
                             scale_y_continuous(name ="log10_Shell; in g") +
                             theme_classic() +
                             theme(legend.position="none",axis.title.y=element_text(size=7)) +
                             ggtitle("Shell scaling: log10_Shell = log10_a + 
                                      (b.factor * log10_Length)") +
                             geom_smooth(method = lm, color = 'red')# +
                             # ggpmisc::stat_poly_eq(parse=T, 
                             #                       aes(label = paste(..eq.label.., ..rr.label.., 
                             #                                       sep = "~~~")),
                             #                          label.x.npc = "left") 

# call dataset - omit data without Shell weights
F1_DryShell <- F1_dryweights_calc %>% 
    dplyr::select(Age, pCO2, Tank_Replicate, Dry_Shell_weight_g, Shell_length_mm) %>% 
    na.omit()
# call the mean Shell dry weight
meanLength.all <- mean(F1_DryShell$Shell_length_mm) # 21.93231
seLength.all   <- sd(F1_DryShell$Shell_length_mm)/sqrt(length((F1_DryShell$Shell_length_mm))) # 0.3850383

StandardShellSize = 40

# age range of animals 
print(paste0('youngest = ', min(F1_DryShell$Age), '; oldest = ', max(F1_DryShell$Age)))


#assign bfactors
bLength.all <- 2.92 #3.11 
bLength.low <- 2.91#3.13
bLength.mod <- 2.92#3.10
# standardize Shell dry weight using bfactors
F1_DryShell.bfactor <- F1_DryShell %>% 
                          dplyr::mutate(
                           Shell_bFactorLength.all  =  ( (Dry_Shell_weight_g * (Shell_length_mm^-bLength.all))* # a
                                                                    (StandardShellSize^bLength.all) ) * 100,
                           Shell_bFactorLength.pCO2 =  case_when(pCO2 == '500 μatm' ~
                                                                   ( (Dry_Shell_weight_g * (Shell_length_mm^-bLength.low))* # a
                                                                      (StandardShellSize^bLength.low) ) * 100,
                                                                 pCO2 == '800 μatm' ~ 
                                                                   ( (Dry_Shell_weight_g * (Shell_length_mm^-bLength.mod))* # a
                                                                      (StandardShellSize^bLength.mod) ) * 100
                           ) # case when for pCO2 
                          ) # mutate
# pivot longer and plot 
F1_DryShell.bfactor.long <- F1_DryShell.bfactor %>% 
                              dplyr::select(-Shell_length_mm) %>% 
                              tidyr::pivot_longer(
                                cols = c(Dry_Shell_weight_g, Shell_bFactorLength.all, Shell_bFactorLength.pCO2),
                                names_to = "measurement",
                                values_to = "value"
                              )
# means by replicate tank 
F1_DryShell.bfactor.long.MEANS <- F1_DryShell.bfactor.long %>% 
                                    summarySE(measurevar="value", 
                                               groupvars=c("Age","pCO2", "Tank_Replicate", "measurement")) %>% 
                                    dplyr::arrange(as.numeric(Age))

# mmeans master - median for E-H as A-D!
F1_DryShell.bfactor.long.MEANS_master <- F1_DryShell.bfactor.long.MEANS %>%  # noew convert and resummarize by tank
                        dplyr::mutate(Tank_Replicate = case_when(
                                      Tank_Replicate == 'E' ~ 'A', #convert E to A
                                      Tank_Replicate == 'F' ~ 'B', #convert F to B
                                      Tank_Replicate == 'G' ~ 'C', #convert G to C
                                      Tank_Replicate == 'H' ~ 'D', #convert H to D
                                      .default = (as.character(Tank_Replicate)) # for cases A-D, keep em my mans
                                    )) %>% 
                        summarySE(measurevar="value", 
                                  groupvars=c("Age","pCO2", "Tank_Replicate", "measurement")) %>% # summarize again
                        dplyr::arrange(as.numeric(Age), measurement, pCO2, Tank_Replicate)
# 
Shell_bfactor.MeanSE <-ggplot(F1_DryShell.bfactor.long.MEANS_master,
                                 aes(x=factor(Age), 
                                     y=value, 
                                     colour=factor(pCO2)),
                                      stat="identity") +
                           scale_colour_manual(breaks=c("500 μatm", "800 μatm"), 
                                             values=c("forestgreen","darkorange2")) +
                           geom_point(aes(colour = pCO2), 
                                            position = position_dodge2(width = 0.5)) + 
                           stat_summary(fun.y="mean", size = 0.8,
                                              position = position_dodge2(width = 0.5)) +
                           stat_summary(fun.min = function(x) mean(x) - sd(x)/sqrt(length(x)), 
                                              fun.max = function(x) mean(x) + sd(x)/sqrt(length(x)),
                                              geom = 'errorbar', width = 0.25, size = 1,
                                              position = position_dodge2(width = 0.5)) + 
                           labs(title="Mean + SE data", 
                                                      x ="Age (dpf)", 
                                                      y = "value") +
                          # scale_y_continuous(expand = c(0, 0), limits = c(0, NA)) +
                          theme_classic() +
                          theme(panel.grid.major = element_blank(), 
                                panel.grid.minor = element_blank(), 
                                # axis.title.y=element_blank(),
                                # axis.title.x=element_blank(),
                                axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=1),
                                axis.text=element_text(size=8),
                                plot.title = element_text(size=12),
                                legend.position="none") +
                          facet_wrap(~measurement, scales = "free_y")


pdf("Output/DryWeights/F1/length_scaling/Dry_Shell_byLength.pdf", height=8, width =8)
ggarrange(bfactorShell.Length.all, bfactorShell.Length.pCO2,Shell_bfactor.MeanSE, nrow=3)
dev.off()


Shell_final_plot <- F1_DryShell.bfactor.long.MEANS_master %>% 
                          dplyr::filter(measurement %in% 'Shell_bFactorLength.pCO2') %>% 
                          ggplot(aes(x=factor(Age), y=value, colour=factor(pCO2)),stat="identity") +
                           scale_colour_manual(breaks=c("500 μatm", "800 μatm"), 
                                                        values=c("forestgreen","darkorange2")) +
                          stat_summary(fun.y="mean", size = 0.8,
                                        position = position_dodge2(width = 0.25)) +
                          stat_summary(fun.min = function(x) mean(x) - sd(x)/sqrt(length(x)), 
                                        fun.max = function(x) mean(x) + sd(x)/sqrt(length(x)),
                                        geom = 'errorbar', width = 0.25, size = 1,
                                        position = position_dodge2(width = 0.5)) + 
                          labs(title="Shell: Length b factor pCO2", x ="Age (dpf)", y = "Dry Shell (mg Lengthbfactor_all)") +
                          theme_classic() +
                          theme(panel.grid.major = element_blank(), 
                                panel.grid.minor = element_blank(), 
                                axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=1),
                                axis.text=element_text(size=8),
                                plot.title = element_text(size=12),
                                legend.position="none")

Shell_final_plot_SUBSET <- F1_DryShell.bfactor.long.MEANS_master %>% 
                          dplyr::filter(Age >= 233 & measurement %in% 'Shell_bFactorLength.pCO2') %>% 
                          ggplot(aes(x=factor(Age), y=value, colour=factor(pCO2)),stat="identity") +
                           scale_colour_manual(breaks=c("500 μatm", "800 μatm"), 
                                                        values=c("forestgreen","darkorange2")) +
                          stat_summary(fun.y="mean", size = 0.8,
                                        position = position_dodge2(width = 0.25)) +
                          stat_summary(fun.min = function(x) mean(x) - sd(x)/sqrt(length(x)), 
                                        fun.max = function(x) mean(x) + sd(x)/sqrt(length(x)),
                                        geom = 'errorbar', width = 0.25, size = 1,
                                        position = position_dodge2(width = 0.5)) + 
                          labs(title="Shell: Length b factor pCO2", x ="Age (dpf)", y = "Dry Shell (mg Lengthbfactor_all)") +
                          theme_classic() +
                          theme(panel.grid.major = element_blank(), 
                                panel.grid.minor = element_blank(), 
                                axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=1),
                                axis.text=element_text(size=8),
                                plot.title = element_text(size=12),
                                legend.position="none")
```

# Dry Shell stats
```{r Shell Stats raw - no standardization}

F1_DryShell.raw.MEAN <- F1_DryShell.bfactor.long.MEANS_master %>% 
                                dplyr::filter(measurement %in% 'Dry_Shell_weight_g')
F1_DryShell.raw.MEAN$DPvar    <- F1_DryShell.raw.MEAN$value
F1_DryShell.raw.MEAN$INDvar   <- F1_DryShell.raw.MEAN$pCO2
F1_DryShell.raw.MEAN$GROUPvar <- F1_DryShell.raw.MEAN$Age

Stats_ShellMEAN_raw <- as.data.frame(runstats(F1_DryShell.raw.MEAN))
Ttest_ShellMEAN_raw <- as.data.frame(run_ttest(F1_DryShell.raw.MEAN))

# About column
Stats_ShellMEAN_raw$About <- paste0("Shell: raw, NO BFACTOR + mean data")
Ttest_ShellMEAN_raw$About <- paste0("Shell: raw, NO BFACTOR + mean data")

```

```{r Mean Shell Stats bfactor all - length standardized}

F1_DryShell.bfactor.MEAN <- F1_DryShell.bfactor.long.MEANS_master %>% 
                                dplyr::filter(measurement %in% 'Shell_bFactorLength.all')
F1_DryShell.bfactor.MEAN$DPvar    <- F1_DryShell.bfactor.MEAN$value
F1_DryShell.bfactor.MEAN$INDvar   <- F1_DryShell.bfactor.MEAN$pCO2
F1_DryShell.bfactor.MEAN$GROUPvar <- F1_DryShell.bfactor.MEAN$Age

Stats_ShellMEAN_bfactor.all <- as.data.frame(runstats(F1_DryShell.bfactor.MEAN))
Ttest_ShellMEAN_bfactor.all <- as.data.frame(run_ttest(F1_DryShell.bfactor.MEAN))

# About column
Stats_ShellMEAN_bfactor.all$About <- paste0("Shell: one bfactor + mean data")
Ttest_ShellMEAN_bfactor.all$About <- paste0("Shell: one bfactor + mean data")

```

```{r Mean Shell Stats bfactor pCO2 - length standardized}

# means by replicate tank within treamtent and day/age
F1_DryShell.bfactor.MEAN <- F1_DryShell.bfactor.long.MEANS_master %>% 
                                dplyr::filter(measurement %in% 'Shell_bFactorLength.pCO2')
F1_DryShell.bfactor.MEAN$DPvar    <- F1_DryShell.bfactor.MEAN$value
F1_DryShell.bfactor.MEAN$INDvar   <- F1_DryShell.bfactor.MEAN$pCO2
F1_DryShell.bfactor.MEAN$GROUPvar <- F1_DryShell.bfactor.MEAN$Age

Stats_ShellMEAN_bfactor.pCO2 <- as.data.frame(runstats(F1_DryShell.bfactor.MEAN))
Ttest_ShellMEAN_bfactor.pCO2 <- as.data.frame(run_ttest(F1_DryShell.bfactor.MEAN))

# About column
Stats_ShellMEAN_bfactor.pCO2$About <- paste0("Shell: two pCO2 bfactors + mean data")
Ttest_ShellMEAN_bfactor.pCO2$About <- paste0("Shell: two pCO2 bfactors + mean data")

```

* merge all Shell stats, save
```{r}

ShellMaster_stats <- rbind(Stats_ShellMEAN_raw, Stats_ShellMEAN_bfactor.all, Stats_ShellMEAN_bfactor.pCO2)

write.csv(ShellMaster_stats, "Output/DryWeights/F1/F1_Shell_DryWeight_ANOVA_table.csv")

ShellMaster_Ttest <- rbind(Ttest_ShellMEAN_raw, Ttest_ShellMEAN_bfactor.all, Ttest_ShellMEAN_bfactor.pCO2)

write.csv(ShellMaster_Ttest, "Output/DryWeights/F1/F1_Shell_DryWeight_Ttest_table.csv")
```














# Total tissue weight: b factor calc and plot
```{r Total tissue b factor calc and plot}
# b factor for Shell? 
LogDryTissue <- F1_dryweights_calc.long.MEANS_master %>% 
                          dplyr::filter(measurement %in% c('Total_Dry_Tissue_g', 'Shell_length_mm')) %>%
                          # dplyr::group_by(measurement) %>% 
                          tidyr::pivot_wider(
                                              names_from = measurement,
                                              values_from = value
                          ) %>% 
                          # dplyr::select(-row) %>% 
                          dplyr::group_by(Age, pCO2, Tank_Replicate) %>%    
                          dplyr::mutate(log10_Tissue   = log10(Total_Dry_Tissue_g),
                                        log10_Length = log10(Shell_length_mm)) %>% 
                          na.omit() %>% # we only have shell for later life stage - omit rows without it
                          dplyr::filter(!log10_Tissue %in% '-Inf') # ommit instances when shell weight == 0

bfactorTissue.Length.pCO2 <- LogDryTissue %>% ggplot(aes(x=log10_Length, y=log10_Tissue, color = pCO2)) +
                          geom_point() +
                          ggpmisc::stat_ma_line(method = "SMA") + # model 2 regression Standard major axis!
                          ggpmisc::stat_ma_eq(use_label(c("eq", "n", "R2"))) +
                          theme(panel.grid.major = element_blank(), 
                                      panel.grid.minor = element_blank())+ 
                             scale_colour_manual(breaks=c("500 μatm", "800 μatm"), 
                                             values=c("forestgreen","darkorange2")) +
                             scale_x_continuous(name ="log10_Length; in mm") +
                             scale_y_continuous(name ="log10_Tissue; in g)") +
                             theme_classic() +
                             theme(legend.position="none",axis.title.y=element_text(size=7)) +
                             ggtitle("Total Tissue scaling: log10_Tissue = log10_a + 
                                      (b.factor * log10_Length)") +
                             # geom_smooth(method = lm, color = 'red') +
                             # ggpmisc::stat_poly_eq(parse=T, 
                             #                       aes(label = paste(..eq.label.., ..rr.label.., 
                             #                                       sep = "~~~")),
                             #                          label.x.npc = "left") +
                             facet_wrap(~pCO2)


bfactorTissue.Length.all <- LogDryTissue %>% ggplot(aes(x=log10_Length, y=log10_Tissue)) +
                          geom_point() +
                          ggpmisc::stat_ma_line(method = "SMA") + # model 2 regression Standard major axis!
                          ggpmisc::stat_ma_eq(use_label(c("eq", "n", "R2"))) +
                          theme(panel.grid.major = element_blank(), 
                                      panel.grid.minor = element_blank())+ 
                             scale_x_continuous(name ="log10_Length; in mm") +
                             scale_y_continuous(name ="log10_Tissue; in g") +
                             theme_classic() +
                             theme(legend.position="none",axis.title.y=element_text(size=7)) +
                             ggtitle("Total tissue scaling: log10_Tissue = log10_a + 
                                      (b.factor * log10_Length)") +
                             geom_smooth(method = lm, color = 'red')# +
                             # ggpmisc::stat_poly_eq(parse=T, 
                             #                       aes(label = paste(..eq.label.., ..rr.label.., 
                             #                                       sep = "~~~")),
                             #                          label.x.npc = "left") 

# call dataset - omit data without Shell weights
F1_DryTissue <- F1_dryweights_calc %>% 
    dplyr::select(Age, pCO2, Tank_Replicate, Total_Dry_Tissue_g, Shell_length_mm) %>% 
    na.omit()
# call the mean Shell dry weight
meanLength.all <- mean(F1_DryTissue$Shell_length_mm) # 21.93231
seLength.all   <- sd(F1_DryTissue$Shell_length_mm)/sqrt(length((F1_DryTissue$Shell_length_mm))) # 0.3850383

StandardShellSize = 40

# age range of animals 
print(paste0('youngest = ', min(F1_DryTissue$Age), '; oldest = ', max(F1_DryTissue$Age)))
#assign bfactors
bLength.all <- 3.16 #3.47 
bLength.low <- 3.14#3.53
bLength.mod <- 3.18#3.44
# standardize Shell dry weight using bfactors
F1_DryTissue.bfactor <- F1_DryTissue %>% 
                          dplyr::mutate(
                           Tissue_bFactorLength.all  =  ( (Total_Dry_Tissue_g * (Shell_length_mm^-bLength.all))* # a
                                                                    (StandardShellSize^bLength.all) ) * 100,
                           Tissue_bFactorLength.pCO2 =  case_when(pCO2 == '500 μatm' ~
                                                                   ( (Total_Dry_Tissue_g * (Shell_length_mm^-bLength.low))* # a
                                                                      (StandardShellSize^bLength.low) ) * 100,
                                                                 pCO2 == '800 μatm' ~ 
                                                                   ( (Total_Dry_Tissue_g * (Shell_length_mm^-bLength.mod))* # a
                                                                      (StandardShellSize^bLength.mod) ) * 100
                           ) # case when for pCO2 
                          ) # mutate
# pivot longer and plot 
F1_DryTissue.bfactor.long <- F1_DryTissue.bfactor %>% 
                              dplyr::select(-Shell_length_mm) %>% 
                              tidyr::pivot_longer(
                                cols = c(Total_Dry_Tissue_g, Tissue_bFactorLength.all, Tissue_bFactorLength.pCO2),
                                names_to = "measurement",
                                values_to = "value"
                              )
# means by replicate tank 
F1_DryTissue.bfactor.long.MEANS <- F1_DryTissue.bfactor.long %>% 
                                    summarySE(measurevar="value", 
                                               groupvars=c("Age","pCO2", "Tank_Replicate", "measurement")) %>% 
                                    dplyr::arrange(as.numeric(Age))
# mmeans master - median for E-H as A-D!
F1_DryTissue.bfactor.long.MEANS_master <- F1_DryTissue.bfactor.long.MEANS %>%  # noew convert and resummarize by tank
                        dplyr::mutate(Tank_Replicate = case_when(
                                      Tank_Replicate == 'E' ~ 'A', #convert E to A
                                      Tank_Replicate == 'F' ~ 'B', #convert F to B
                                      Tank_Replicate == 'G' ~ 'C', #convert G to C
                                      Tank_Replicate == 'H' ~ 'D', #convert H to D
                                      .default = (as.character(Tank_Replicate)) # for cases A-D, keep em my mans
                                    )) %>% 
                        summarySE(measurevar="value", 
                                  groupvars=c("Age","pCO2", "Tank_Replicate", "measurement")) %>% # summarize again
                        dplyr::arrange(as.numeric(Age), measurement, pCO2, Tank_Replicate)

Tissue_bfactor.MeanSE <-ggplot(F1_DryTissue.bfactor.long.MEANS,
                                 aes(x=factor(Age), 
                                     y=value, 
                                     colour=factor(pCO2)),
                                      stat="identity") +
                           scale_colour_manual(breaks=c("500 μatm", "800 μatm"), 
                                             values=c("forestgreen","darkorange2")) +
                           geom_point(aes(colour = pCO2), 
                                            position = position_dodge2(width = 0.5)) + 
                           stat_summary(fun.y="mean", size = 0.8,
                                              position = position_dodge2(width = 0.5)) +
                           stat_summary(fun.min = function(x) mean(x) - sd(x)/sqrt(length(x)), 
                                              fun.max = function(x) mean(x) + sd(x)/sqrt(length(x)),
                                              geom = 'errorbar', width = 0.25, size = 1,
                                              position = position_dodge2(width = 0.5)) + 
                           labs(title="Mean + SE data", 
                                                      x ="Age (dpf)", 
                                                      y = "value") +
                          # scale_y_continuous(expand = c(0, 0), limits = c(0, NA)) +
                          theme_classic() +
                          theme(panel.grid.major = element_blank(), 
                                panel.grid.minor = element_blank(), 
                                # axis.title.y=element_blank(),
                                # axis.title.x=element_blank(),
                                axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=1),
                                axis.text=element_text(size=8),
                                plot.title = element_text(size=12),
                                legend.position="none") +
                          facet_wrap(~measurement, scales = "free_y")


pdf("Output/DryWeights/F1/length_scaling/Dry_TotalTissue_byLength.pdf", height=8, width =8)
ggarrange(bfactorTissue.Length.all, bfactorTissue.Length.pCO2, Tissue_bfactor.MeanSE, nrow=3)
dev.off()

Tissue_final_plot <- F1_DryTissue.bfactor.long.MEANS_master %>% 
                          dplyr::filter(measurement %in% 'Tissue_bFactorLength.pCO2') %>% 
                          ggplot(aes(x=factor(Age), y=value, colour=factor(pCO2)),stat="identity") +
                           scale_colour_manual(breaks=c("500 μatm", "800 μatm"), 
                                                        values=c("forestgreen","darkorange2")) +
                          stat_summary(fun.y="mean", size = 0.8,
                                        position = position_dodge2(width = 0.25)) +
                          stat_summary(fun.min = function(x) mean(x) - sd(x)/sqrt(length(x)), 
                                        fun.max = function(x) mean(x) + sd(x)/sqrt(length(x)),
                                        geom = 'errorbar', width = 0.25, size = 1,
                                        position = position_dodge2(width = 0.5)) + 
                          labs(title="Tissue: Length b factor pCO2", x ="Age (dpf)", y = "Dry Tissue (mg Lengthbfactor_all)") +
                          theme_classic() +
                          theme(panel.grid.major = element_blank(), 
                                panel.grid.minor = element_blank(), 
                                axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=1),
                                axis.text=element_text(size=8),
                                plot.title = element_text(size=12),
                                legend.position="none")

Tissue_final_plot_SUBSET <- F1_DryTissue.bfactor.long.MEANS_master %>% 
                          dplyr::filter(Age >= 233 & measurement %in% 'Tissue_bFactorLength.pCO2') %>% 
                          ggplot(aes(x=factor(Age), y=value, colour=factor(pCO2)),stat="identity") +
                           scale_colour_manual(breaks=c("500 μatm", "800 μatm"), 
                                                        values=c("forestgreen","darkorange2")) +
                          stat_summary(fun.y="mean", size = 0.8,
                                        position = position_dodge2(width = 0.25)) +
                          stat_summary(fun.min = function(x) mean(x) - sd(x)/sqrt(length(x)), 
                                        fun.max = function(x) mean(x) + sd(x)/sqrt(length(x)),
                                        geom = 'errorbar', width = 0.25, size = 1,
                                        position = position_dodge2(width = 0.5)) + 
                          labs(title="Tissue: Length b factor pCO2", x ="Age (dpf)", y = "Dry Tissue (mg Lengthbfactor_all)") +
                          theme_classic() +
                          theme(panel.grid.major = element_blank(), 
                                panel.grid.minor = element_blank(), 
                                axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=1),
                                axis.text=element_text(size=8),
                                plot.title = element_text(size=12),
                                legend.position="none")
```

# Dry Tissue stats
```{r Tissue Stats raw - no standardization}
library(purrr)
library(rstatix)
F1_DryTissue.raw.MEAN <- F1_DryTissue.bfactor.long.MEANS_master %>% 
                                dplyr::filter(measurement %in% 'Total_Dry_Tissue_g')
F1_DryTissue.raw.MEAN$DPvar    <- F1_DryTissue.raw.MEAN$value
F1_DryTissue.raw.MEAN$INDvar   <- F1_DryTissue.raw.MEAN$pCO2
F1_DryTissue.raw.MEAN$GROUPvar <- F1_DryTissue.raw.MEAN$Age

Stats_TissueMEAN_raw <- as.data.frame(runstats(F1_DryTissue.raw.MEAN))
Ttest_TissueMEAN_raw <- as.data.frame(run_ttest(F1_DryTissue.raw.MEAN))
# About column
Stats_TissueMEAN_raw$About <- paste0("Tissue: raw, NO BFACTOR + mean data")
Ttest_TissueMEAN_raw$About <- paste0("Tissue: raw, NO BFACTOR + mean data")
```

```{r Mean Tissue Stats bfactor all - length standardized}

F1_DryTissue.bfactor.MEAN <- F1_DryTissue.bfactor.long.MEANS_master %>% 
                                dplyr::filter(measurement %in% 'Tissue_bFactorLength.all')
F1_DryTissue.bfactor.MEAN$DPvar    <- F1_DryTissue.bfactor.MEAN$value
F1_DryTissue.bfactor.MEAN$INDvar   <- F1_DryTissue.bfactor.MEAN$pCO2
F1_DryTissue.bfactor.MEAN$GROUPvar <- F1_DryTissue.bfactor.MEAN$Age

Stats_TissueMEAN_bfactor.all <- as.data.frame(runstats(F1_DryTissue.bfactor.MEAN))
Ttest_TissueMEAN_bfactor.all <- as.data.frame(run_ttest(F1_DryTissue.bfactor.MEAN))

# About column
Stats_TissueMEAN_bfactor.all$About <- paste0("Tissue: one bfactor + mean data")
Ttest_TissueMEAN_bfactor.all$About <- paste0("Tissue: one bfactor + mean data")

```

```{r Mean Tissue Stats bfactor pCO2 - length standardized}

# means by replicate tank within treamtent and day/age
F1_DryTissue.bfactor.MEAN <- F1_DryTissue.bfactor.long.MEANS_master %>% 
                                dplyr::filter(measurement %in% 'Tissue_bFactorLength.pCO2')
F1_DryTissue.bfactor.MEAN$DPvar    <- F1_DryTissue.bfactor.MEAN$value
F1_DryTissue.bfactor.MEAN$INDvar   <- F1_DryTissue.bfactor.MEAN$pCO2
F1_DryTissue.bfactor.MEAN$GROUPvar <- F1_DryTissue.bfactor.MEAN$Age

Stats_TissueMEAN_bfactor.pCO2 <- as.data.frame(runstats(F1_DryTissue.bfactor.MEAN))
Ttest_TissueMEAN_bfactor.pCO2 <- as.data.frame(run_ttest(F1_DryTissue.bfactor.MEAN))

# About column
Stats_TissueMEAN_bfactor.pCO2$About <- paste0("Tissue: two pCO2 bfactors + mean data")
Ttest_TissueMEAN_bfactor.pCO2$About <- paste0("Tissue: two pCO2 bfactors + mean data")

```

* merge all Tissue stats, save
```{r}

TissueMaster_stats <- rbind(Stats_TissueMEAN_raw, Stats_TissueMEAN_bfactor.all, Stats_TissueMEAN_bfactor.pCO2)

write.csv(TissueMaster_stats, "Output/DryWeights/F1/F1_Tissue_DryWeight_ANOVA_table.csv")

Ttest_TissueMaster_stats <- rbind(Ttest_TissueMEAN_raw, Ttest_TissueMEAN_bfactor.all, Ttest_TissueMEAN_bfactor.pCO2)

write.csv(Ttest_TissueMaster_stats, "Output/DryWeights/F1/F1_Tissue_DryWeight_ttest_table.csv")
```


















# Whole animal dry weight: b factor calc and plot
```{r Whole animal dry weight b factor calc and plot}
# b factor for Shell? 
LogWholeDry <- F1_dryweights_calc.long.MEANS_master %>% 
                          dplyr::filter(Age > 50) %>%  # including 50 dpf and downstream b factor nomrm is an outlier - perhaps these were too small to relate to remaining data?
                          dplyr::filter(measurement %in% c('Whole_animal_dry_weight_g', 'Shell_length_mm')) %>%
                          # dplyr::group_by(measurement) %>% 
                          tidyr::pivot_wider(
                                              names_from = measurement,
                                              values_from = value
                          ) %>% 
                          # dplyr::select(-row) %>% 
                          dplyr::group_by(Age, pCO2, Tank_Replicate) %>%    
                          dplyr::mutate(log10_WholeDry   = log10(Whole_animal_dry_weight_g),
                                        log10_Length = log10(Shell_length_mm)) %>% 
                          na.omit() %>% # we only have shell for later life stage - omit rows without it
                          dplyr::filter(!log10_WholeDry %in% '-Inf') # ommit instances when shell weight == 0

bfactorWholeDry.Length.pCO2 <- LogWholeDry %>% ggplot(aes(x=log10_Length, y=log10_WholeDry, color = pCO2)) +
                          geom_point() +
                          ggpmisc::stat_ma_line(method = "SMA") + # model 2 regression Standard major axis!
                          ggpmisc::stat_ma_eq(use_label(c("eq", "n", "R2"))) +
                          theme(panel.grid.major = element_blank(), 
                                      panel.grid.minor = element_blank())+ 
                             scale_colour_manual(breaks=c("500 μatm", "800 μatm"), 
                                             values=c("forestgreen","darkorange2")) +
                             scale_x_continuous(name ="log10_Length; in mm") +
                             scale_y_continuous(name ="log10_WholeDry; in g)") +
                             theme_classic() +
                             theme(legend.position="none",axis.title.y=element_text(size=7)) +
                             ggtitle("Whole Dry Scaling: log10_WholeDry = log10_a + 
                                      (b.factor * log10_Length)") +
                             # geom_smooth(method = lm, color = 'red') +
                             # ggpmisc::stat_poly_eq(parse=T, 
                             #                       aes(label = paste(..eq.label.., ..rr.label.., 
                             #                                       sep = "~~~")),
                             #                          label.x.npc = "left") +
                             facet_wrap(~pCO2)


bfactorWholeDry.Length.all <- LogWholeDry %>% ggplot(aes(x=log10_Length, y=log10_WholeDry)) +
                          geom_point() +
                          ggpmisc::stat_ma_line(method = "SMA") + # model 2 regression Standard major axis!
                          ggpmisc::stat_ma_eq(use_label(c("eq", "n", "R2"))) +
                          theme(panel.grid.major = element_blank(), 
                                      panel.grid.minor = element_blank())+ 
                             scale_x_continuous(name ="log10_Length; in mm") +
                             scale_y_continuous(name ="log10_WholeDry; in g") +
                             theme_classic() +
                             theme(legend.position="none",axis.title.y=element_text(size=7)) +
                             ggtitle("Whole Dry Scaling: log10_WholeDry = log10_a + 
                                      (b.factor * log10_Length)") +
                             geom_smooth(method = lm, color = 'red')# +
                             # ggpmisc::stat_poly_eq(parse=T, 
                             #                       aes(label = paste(..eq.label.., ..rr.label.., 
                             #                                       sep = "~~~")),
                             #                          label.x.npc = "left") 

# call dataset - omit data without Shell weights
F1_WholeDry <- F1_dryweights_calc %>% 
    dplyr::filter(Age > 50) %>% 
    dplyr::select(Age, pCO2, Tank_Replicate, Whole_animal_dry_weight_g, Shell_length_mm) %>% 
    na.omit()
# call the mean Shell dry weight
meanLength.all <- mean(F1_WholeDry$Shell_length_mm) # 20.92713
seLength.all   <- sd(F1_WholeDry$Shell_length_mm)/sqrt(length((F1_WholeDry$Shell_length_mm))) # 0.3959968
# age range of animals 
print(paste0('youngest = ', min(F1_WholeDry$Age), '; oldest = ', max(F1_WholeDry$Age)))
#assign bfactors
bLength.all <- 2.99#3.13 
bLength.low <- 2.99#3.14
bLength.mod <- 2.98#3.11
# standardize Shell dry weight using bfactors
F1_WholeDry.bfactor <- F1_WholeDry %>% 
                          dplyr::mutate(
                           WholeDry_bFactorLength.all  =  ( (Whole_animal_dry_weight_g * (Shell_length_mm^-bLength.all))* # a
                                                                    (meanLength.all^bLength.all) ) * 100,
                           WholeDry_bFactorLength.pCO2 =  case_when(pCO2 == '500 μatm' ~
                                                                   ( (Whole_animal_dry_weight_g * (Shell_length_mm^-bLength.low))* # a
                                                                      (meanLength.all^bLength.low)  ) * 100,
                                                                 pCO2 == '800 μatm' ~ 
                                                                   ( (Whole_animal_dry_weight_g * (Shell_length_mm^-bLength.mod))* # a
                                                                      (meanLength.all^bLength.mod) ) * 100
                           ) # case when for pCO2 
                          ) # mutate
# pivot longer and plot 
F1_WholeDry.bfactor.long <- F1_WholeDry.bfactor %>% 
                              dplyr::select(-Shell_length_mm) %>% 
                              tidyr::pivot_longer(
                                cols = c(Whole_animal_dry_weight_g, WholeDry_bFactorLength.all, WholeDry_bFactorLength.pCO2),
                                names_to = "measurement",
                                values_to = "value"
                              )
# means by replicate tank 
F1_WholeDry.bfactor.long.MEANS <- F1_WholeDry.bfactor.long %>% 
                                    summarySE(measurevar="value", 
                                               groupvars=c("Age","pCO2", "Tank_Replicate", "measurement")) %>% 
                                    dplyr::arrange(as.numeric(Age))
# mmeans master - median for E-H as A-D!
F1_WholeDry.bfactor.long.MEANS_master <- F1_WholeDry.bfactor.long.MEANS %>%  # noew convert and resummarize by tank
                        dplyr::mutate(Tank_Replicate = case_when(
                                      Tank_Replicate == 'E' ~ 'A', #convert E to A
                                      Tank_Replicate == 'F' ~ 'B', #convert F to B
                                      Tank_Replicate == 'G' ~ 'C', #convert G to C
                                      Tank_Replicate == 'H' ~ 'D', #convert H to D
                                      .default = (as.character(Tank_Replicate)) # for cases A-D, keep em my mans
                                    )) %>% 
                        summarySE(measurevar="value", 
                                  groupvars=c("Age","pCO2", "Tank_Replicate", "measurement")) %>% # summarize again
                        dplyr::arrange(as.numeric(Age), measurement, pCO2, Tank_Replicate)

WholeDry_bfactor.MeanSE <-ggplot(F1_WholeDry.bfactor.long.MEANS,
                                 aes(x=factor(Age), 
                                     y=value, 
                                     colour=factor(pCO2)),
                                      stat="identity") +
                           scale_colour_manual(breaks=c("500 μatm", "800 μatm"), 
                                             values=c("forestgreen","darkorange2")) +
                           geom_point(aes(colour = pCO2), 
                                            position = position_dodge2(width = 0.5)) + 
                           stat_summary(fun.y="mean", size = 0.8,
                                              position = position_dodge2(width = 0.5)) +
                           stat_summary(fun.min = function(x) mean(x) - sd(x)/sqrt(length(x)), 
                                              fun.max = function(x) mean(x) + sd(x)/sqrt(length(x)),
                                              geom = 'errorbar', width = 0.25, size = 1,
                                              position = position_dodge2(width = 0.5)) + 
                           labs(title="Mean + SE data", 
                                                      x ="Age (dpf)", 
                                                      y = "value") +
                          # scale_y_continuous(expand = c(0, 0), limits = c(0, NA)) +
                          theme_classic() +
                          theme(panel.grid.major = element_blank(), 
                                panel.grid.minor = element_blank(), 
                                # axis.title.y=element_blank(),
                                # axis.title.x=element_blank(),
                                axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=1),
                                axis.text=element_text(size=8),
                                plot.title = element_text(size=12),
                                legend.position="none") +
                          facet_wrap(~measurement, scales = "free_y")


pdf("Output/DryWeights/F1/length_scaling/Dry_WholeDryWeight_byLength.pdf", height=8, width =8)
ggarrange(bfactorWholeDry.Length.all, bfactorWholeDry.Length.pCO2,WholeDry_bfactor.MeanSE, nrow=3)
dev.off()



WholeDry_final_plot <- F1_WholeDry.bfactor.long.MEANS_master %>% 
                          dplyr::filter(measurement %in% 'WholeDry_bFactorLength.pCO2') %>% 
                          ggplot(aes(x=factor(Age), y=value, colour=factor(pCO2)),stat="identity") +
                           scale_colour_manual(breaks=c("500 μatm", "800 μatm"), 
                                                        values=c("forestgreen","darkorange2")) +
                          stat_summary(fun.y="mean", size = 0.8,
                                        position = position_dodge2(width = 0.25)) +
                          stat_summary(fun.min = function(x) mean(x) - sd(x)/sqrt(length(x)), 
                                        fun.max = function(x) mean(x) + sd(x)/sqrt(length(x)),
                                        geom = 'errorbar', width = 0.25, size = 1,
                                        position = position_dodge2(width = 0.5)) + 
                          labs(title="Whole Dry: Length b factor pCO2", x ="Age (dpf)", y = "Dry Tissue (mg Lengthbfactor_all)") +
                          theme_classic() +
                          theme(panel.grid.major = element_blank(), 
                                panel.grid.minor = element_blank(), 
                                axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=1),
                                axis.text=element_text(size=8),
                                plot.title = element_text(size=12),
                                legend.position="none")

WholeDry_final_plot_SUBSET <- F1_WholeDry.bfactor.long.MEANS_master %>% 
                          dplyr::filter(Age >= 233 & measurement %in% 'WholeDry_bFactorLength.pCO2') %>% 
                          ggplot(aes(x=factor(Age), y=value, colour=factor(pCO2)),stat="identity") +
                           scale_colour_manual(breaks=c("500 μatm", "800 μatm"), 
                                                        values=c("forestgreen","darkorange2")) +
                          stat_summary(fun.y="mean", size = 0.8,
                                        position = position_dodge2(width = 0.25)) +
                          stat_summary(fun.min = function(x) mean(x) - sd(x)/sqrt(length(x)), 
                                        fun.max = function(x) mean(x) + sd(x)/sqrt(length(x)),
                                        geom = 'errorbar', width = 0.25, size = 1,
                                        position = position_dodge2(width = 0.5)) + 
                          labs(title="Whole Dry: Length b factor pCO2", x ="Age (dpf)", y = "Dry Tissue (mg Lengthbfactor_all)") +
                          theme_classic() +
                          theme(panel.grid.major = element_blank(), 
                                panel.grid.minor = element_blank(), 
                                axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=1),
                                axis.text=element_text(size=8),
                                plot.title = element_text(size=12),
                                legend.position="none")
```

# Whole Dry stats
```{r WholeDry Stats raw - no standardization}

F1_WholeDry.raw.MEAN <- F1_WholeDry.bfactor.long.MEANS_master %>% 
                                dplyr::filter(measurement %in% 'Whole_animal_dry_weight_g')
F1_WholeDry.raw.MEAN$DPvar    <- F1_WholeDry.raw.MEAN$value
F1_WholeDry.raw.MEAN$INDvar   <- F1_WholeDry.raw.MEAN$pCO2
F1_WholeDry.raw.MEAN$GROUPvar <- F1_WholeDry.raw.MEAN$Age

Stats_WholeDryMEAN_raw <- as.data.frame(runstats(F1_WholeDry.raw.MEAN))
# About column
Stats_WholeDryMEAN_raw$About <- paste0("WholeDryM: raw, NO BFACTOR + mean data")
```

```{r Mean WholeDry Stats bfactor all - length standardized}

F1_WholeDry.bfactor.MEAN <- F1_WholeDry.bfactor.long.MEANS_master %>% 
                                dplyr::filter(measurement %in% 'WholeDry_bFactorLength.all')
F1_WholeDry.bfactor.MEAN$DPvar    <- F1_WholeDry.bfactor.MEAN$value
F1_WholeDry.bfactor.MEAN$INDvar   <- F1_WholeDry.bfactor.MEAN$pCO2
F1_WholeDry.bfactor.MEAN$GROUPvar <- F1_WholeDry.bfactor.MEAN$Age

Stats_WholeDryMEAN_bfactor.all <- as.data.frame(runstats(F1_WholeDry.bfactor.MEAN))
# About column
Stats_WholeDryMEAN_bfactor.all$About <- paste0("WholeDryM: one bfactor + mean data")
```

```{r Mean WholeDry Stats bfactor pCO2 - length standardized}

# means by replicate tank within treamtent and day/age
F1_WholeDry.bfactor.MEAN <- F1_WholeDry.bfactor.long.MEANS_master %>% 
                                dplyr::filter(measurement %in% 'WholeDry_bFactorLength.pCO2')
F1_WholeDry.bfactor.MEAN$DPvar    <- F1_WholeDry.bfactor.MEAN$value
F1_WholeDry.bfactor.MEAN$INDvar   <- F1_WholeDry.bfactor.MEAN$pCO2
F1_WholeDry.bfactor.MEAN$GROUPvar <- F1_WholeDry.bfactor.MEAN$Age

Stats_WholeDryMEAN_bfactor.pCO2 <- as.data.frame(runstats(F1_WholeDry.bfactor.MEAN))
# About column
Stats_WholeDryMEAN_bfactor.pCO2$About <- paste0("WholeDry: two pCO2 bfactors + mean data")
```

* merge all WholeDry stats, save
```{r}

WholeDryMaster_stats <- rbind(Stats_WholeDryMEAN_raw, Stats_WholeDryMEAN_bfactor.all, Stats_WholeDryMEAN_bfactor.pCO2)

write.csv(WholeDryMaster_stats, "Output/DryWeights/F1/F1_Whole_DryWeight_ANOVA_table.csv")
```

# Manuscript plot! 
* If we decide to go with the 'Two pCO2 bfactors data b factor'
then this is what we will use - in the above chunks I made a figure for each metric 
* NOTE: for shell weight, whole tissue and whole animal we have more timepoints, here we subset these to overlap with the 
full dissection of different compartments 
```{r Final Panel Plot}


pdf("Output/DryWeights/F1/DryWeights_bFactorLengthpCO2.pdf", height=10.5, width =8)
print(ggarrange(Gonad_final_plot, Adductor_final_plot,
           Somatic_final_plot, Tissue_final_plot_SUBSET,
          Shell_final_plot_SUBSET, WholeDry_final_plot_SUBSET,
          ncol = 2, nrow = 3
          ))
dev.off()


pdf("Output/DryWeights/F1/DryWeights_bFactorLengthpCO2.pdf", height=7.5, width =10)
print(ggarrange(Gonad_final_plot, Adductor_final_plot,
               Somatic_final_plot, Tissue_final_plot_SUBSET,
               Shell_final_plot_SUBSET,
          ncol = 3, nrow = 2
          ))
dev.off()

```
