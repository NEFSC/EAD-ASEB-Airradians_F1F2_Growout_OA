---
title: "F1_Biodeposition_analysis"
author: "Samuel Gurr"
date: "2024-01-10"
output: html_document
---



```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# SET WORKING DIRECTORY 

# knitr::opts_knit$set(root.dir = "C:/Users/katherine.mcfarland/Documents/GitHub/EAD-ASEB-EAD-ASEB-Airradians_F1F2_Growout_OA/larvae") # Katie's
knitr::opts_knit$set(root.dir = "C:/Users/samjg/Documents/Github_repositories/EAD-ASEB-Airradians_F1F2_Growout_OA/RAnalysis") # Sam's
# knitr::opts_knit$set(root.dir = "C:/Users/samuel.gurr/Documents/Github_repositories/EAD-ASEB-EAD-ASEB-Airradians_F1F2_Growout_OA/RAnalysis") # Sam's

```



```{r load libraries}

library(ggplot2)
library(dplyr)
library(car)
library(Rmisc)
library(forcats)

```


```{r load data}

# F1s

Biodep_Master_F1 <- read.csv("Output/Biodeposition/F1/F1_Biodeposition_master.csv", header = T)
nrow(Biodep_Master_F1) # 43
Biodep_Master_F1 <- na.omit(Biodep_Master_F1) # omit #6 pH7.5 on 20221027
nrow(Biodep_Master_F1) # 43 - no NAs



# format it 
Biodep_Master_F1 <- Biodep_Master_F1 %>% 
                        dplyr::mutate(Age = case_when(Date == "20220302" ~  219, 
                                                       Date == "20220923" ~  424, 
                                                       Date == "20221027" ~  261)) %>% 
                        dplyr::mutate(pCO2 = case_when(treatment == 8 ~ "500 μatm", # add column for pCO2
                                                       treatment == 7.5 ~ "800 μatm")) %>% # %>% #edit this!
                        dplyr::mutate(pCO2 = fct_relevel(pCO2, c("500 μatm","800 μatm")),
                                      Temperature = case_when(Date == "20220302" ~  16,
                                                              Date == "20220923" ~  20,
                                                              Date == "20221027" ~  12))
                                                         
```


## Statistics function 'runstats'
```{r Statistic function}


runstats <- function(datafilename,  outputfilename) {
            # variables for both for loops
            DF_loop           <- data.frame(matrix(nrow = 1, ncol = 11)) # create dataframe to save during for loop
            colnames(DF_loop) <- c('Age_DPF', 'ShapiroWilk', 'ResidNorm', 
                                   'Levenes', 'HomogVar', 'model', 
                                   'DF.num' , 'DF.denom', 
                                   'F_val','P_val', 'SigDif') # names for comuns in the for loop
            
            unique(datafilename$Age)
            outputfilename <- data.frame()

            
            for (i in 1:length(unique(datafilename$Age))) {
              GROUPvar_loop <- unique(datafilename$GROUPvar)[i]
              Data_all      <- datafilename %>% dplyr::filter(GROUPvar %in% GROUPvar_loop)
              # Data_mean   <- Data_all %>% summarySE(measurevar="DPvar", 
              #                                       groupvars=c("group1","Tank_Replicate", "INDvar")) 
              
              AOVmod      <- aov(lm(Data_all$DPvar ~ as.factor(Data_all$INDvar))) # CHANGE HERE!
              KWmod       <- kruskal.test(Data_all$DPvar  ~ as.factor(Data_all$INDvar)) # CHANGE HERE!
              
              # DF_loop$About <- paste0("Gonad: All bfactor + mean by replicate")
              # DF_loop$About <- paste0("Gonad: All bfactor + all data")  # normality tests for the anova model - asign
              
              
              DF_loop$ShapiroWilk <- shapiro.test(resid(AOVmod))[[2]]
              DF_loop$ResidNorm   <- if( shapiro.test(resid(AOVmod))[[2]] > 0.05) {
                  'YES'} else {'NO'}
              DF_loop$Levenes     <- leveneTest(AOVmod)[[3]][[1]]
              DF_loop$HomogVar    <- if( leveneTest(AOVmod)[[3]][[1]] > 0.05) {
                  'YES'} else {'NO'}
                
              if(shapiro.test(resid(AOVmod))[[2]] > 0.05 & leveneTest(AOVmod)[[3]][[1]] > 0.05) {
                    DF_loop$model       <- 'one-way AOV; x ~ treatment'
                    DF_loop$DF.num      <- summary(AOVmod)[[1]][["Df"]][1]
                    DF_loop$DF.denom    <- summary(AOVmod)[[1]][["Df"]][2]
                    DF_loop$F_val       <- summary(AOVmod)[[1]][["F value"]][1]
                    DF_loop$P_val       <- summary(AOVmod)[[1]][["Pr(>F)"]][1]
                    DF_loop$SigDif      <- if( (summary(AOVmod)[[1]][["Pr(>F)"]][1]) > 0.05) {
                      'NO'} else {'YES'}
            
                  } else {
                    DF_loop$model       <- 'kruskal-wallis; x ~ treatment'
                    DF_loop$DF.num      <- (KWmod)[[2]][["df"]][1]
                    DF_loop$DF.denom    <- NA
                    DF_loop$F_val       <- NA
                    DF_loop$P_val       <- (KWmod)[[3]]
                    DF_loop$SigDif      <- if( ((KWmod)[[3]]) > 0.05) {
                      'NO'} else {'YES'}
                  }
              DF_loop$Age_DPF     <- GROUPvar_loop
              # asign loop and cumulative output table
              df                        <- data.frame(DF_loop) # name dataframe for this single row
              outputfilename <- rbind(outputfilename,DF_loop) #bind to a cumulative list dataframe
              # print(outputfilename) # print to monitor progress
              
            }
return(outputfilename)
}


library(purrr)
library(rstatix)

run_ttest <- function(datafilename,  outputfilename) {
            # variables for both for loops
            DF_loop           <- data.frame(matrix(nrow = 1, ncol = 13)) # create dataframe to save during for loop
            colnames(DF_loop) <- c('Age_DPF', 'Metric', 'model', 'ShapiroWilk', 'ResidNorm', 'Variance', 
                                   'HomogVar', 'DF.num' , 'DF.denom', 
                                   'Tstat','P_val', 'SigDif') # names for comuns in the for loop
            
            outputfilename <- data.frame()
            datafilename$value = as.numeric(datafilename$value)
            
            for (m in 1:length(unique(datafilename$type))) { # call the biodep metrics one by one
              
              DPvar_loop <- unique(as.character(datafilename$type))
              Data_DPvar <- datafilename %>% 
                                select(type, GROUPvar, DPvar, INDvar) %>% 
                                dplyr::filter(type %in%  DPvar_loop[m])
              
            
            for (i in 1:length(unique(Data_DPvar$GROUPvar))) {
              GROUPvar_loop <- unique(Data_DPvar$GROUPvar)[i] # Group var is Age (Date) 
              Data_by_day   <- Data_DPvar %>% dplyr::filter(GROUPvar %in% GROUPvar_loop)
              # Data_mean   <- Data_all %>% summarySE(measurevar="DPvar", 
              #                                       groupvars=c("group1","Tank_Replicate", "INDvar")) 
              
            # run assumptions 
            # normality of data 
            normality_A <- (Data_by_day %>% 
                                  group_by(as.factor(INDvar)) %>% 
                                  rstatix::shapiro_test(DPvar))$p[1]
            
            normality_B <- (Data_by_day %>% 
                                  group_by(as.factor(INDvar)) %>% 
                                  rstatix::shapiro_test(DPvar))$p[2]
            
            # equal variance 
            variance <- (Data_by_day %>% rstatix::levene_test(DPvar ~ as.factor(INDvar)))$p[1]
            
            # run all modles
            Ttestmod.eqvar      <- t.test(Data_by_day$DPvar ~ (as.factor(Data_by_day$INDvar)), 
                                           alternative = "greater",
                                           var.equal = TRUE)
            
            Ttestmod.noneqvar   <- t.test(Data_by_day$DPvar ~ (as.factor(Data_by_day$INDvar)),
                                           alternative = "greater",
                                           var.equal = FALSE)
            
            Wilcoxmod           <- wilcox.test(Data_by_day$DPvar ~ 
                                                 as.numeric(as.factor(Data_by_day$INDvar)))
            
            # normality tests for the anova model - asign 
            DF_loop$ShapiroWilk <- paste0(normality_A, '; ',normality_B)
            
            DF_loop$ResidNorm   <- if(normality_A > 0.05 & normality_B > 0.05) {
              'YES'} else {'NO'}
            
            DF_loop$Variance     <- variance
            
            DF_loop$HomogVar    <- if( variance > 0.05) {
              'YES'} else {'NO'}
            
            if(normality_A > 0.05 & normality_B > 0.05 & variance > 0.05) {
                DF_loop$model       <- 'Welchs T test, equal variance'
                DF_loop$DF.num      <- map_df(list(Ttestmod.eqvar), tidy)$parameter[[1]]
                DF_loop$DF.denom    <- 'NA'
                DF_loop$Tstat       <- map_df(list(Ttestmod.eqvar), tidy)$statistic[[1]]
                DF_loop$P_val       <- map_df(list(Ttestmod.eqvar), tidy)$p.value[[1]]
                DF_loop$SigDif      <- if( (map_df(list(Ttestmod.eqvar), tidy)$p.value[[1]]) > 0.05) {
                  'NO'} else {'YES'}
        
              } else if (normality_A > 0.05 & normality_B > 0.05 & variance < 0.05) {
                DF_loop$model       <- 'Welchs T test, non-equal variance'
                DF_loop$DF.num      <- map_df(list(Ttestmod.noneqvar), tidy)$parameter[[1]]
                DF_loop$DF.denom    <- 'NA'
                DF_loop$Tstat       <- map_df(list(Ttestmod.noneqvar), tidy)$statistic[[1]]
                DF_loop$P_val       <- map_df(list(Ttestmod.noneqvar), tidy)$p.value[[1]]
                DF_loop$SigDif      <- if( (map_df(list(Ttestmod.noneqvar), tidy)$p.value[[1]]) > 0.05) {
                  'NO'} else {'YES'}
              } else {
                DF_loop$model       <- 'Wilcoxon rank sum exact test'
                DF_loop$DF.num      <- 'NA'
                DF_loop$DF.denom    <- 'NA'
                DF_loop$Tstat       <- map_df(list(Wilcoxmod), tidy)$statistic[[1]]
                DF_loop$P_val       <- map_df(list(Wilcoxmod), tidy)$p.value[[1]]
                DF_loop$SigDif      <- if( (map_df(list(Wilcoxmod), tidy)$p.value[[1]]) > 0.05) {
                  'NO'} else {'YES'}            
              }
                  DF_loop$Age_DPF     <- GROUPvar_loop
                  DF_loop$Metric      <- DPvar_loop[m]
                  # asign loop and cumulative output table
                  df                        <- data.frame(DF_loop) # name dataframe for this single row
                  outputfilename <- rbind(outputfilename,DF_loop) #bind to a cumulative list dataframe
                  # print(outputfilename) # print to monitor progress
            }
                }
return(outputfilename)
}


```



```{r Long foramat in prep for loop stats}
library(data.table)

# select target columns 
Biodep_Master_F1_select <- Biodep_Master_F1 %>% select(Age,treatment,
                                                       RR_mghr, ORR_mghr, IRR_mghr,ER_mghr,OER_mghr,IER_mghr,        
                                                       IER_correct,IRR_correct,OER_correct,ORR_correct,CR,
                                                       FR,RR_correct,SE,IFR,CR_correct,FR_correct,RR_Percent,
                                                       TIR,OFR,OIR,i,AR, AE)

# long format ready for lop stats
Biodep_Master_F1_long <- as.data.frame(reshape2::melt(setDT(Biodep_Master_F1_select), 
                                                      id.vars = c("Age","treatment"), 
                                                      variable.name = "type")
                                      )


# call the variables needed
Biodep_Master_F1_long$DPvar    <- Biodep_Master_F1_long$value
Biodep_Master_F1_long$INDvar   <- Biodep_Master_F1_long$treatment
Biodep_Master_F1_long$GROUPvar <- Biodep_Master_F1_long$Age

# run the t test loop
F1_Biodeposition_Ttest_Wilcox <- as.data.frame(run_ttest(Biodep_Master_F1_long))
# View(F1_Biodeposition_Ttest_Wilcox)

# output stats
write.csv(F1_Biodeposition_Ttest_Wilcox, "Output/Biodeposition/F1/F1_Biodeposition_Ttest_table.csv")


```


# ```{r}
# 
# # (1) First, run anova within date for all records (for looped!)
# ANOVA_Dates       <- as.data.frame(unique(Biodep_Master_F1$Date)) # call a list to loop in 
# 
# AOVdf_total       <- data.frame() # start dataframe, this will be the master output
# 
# DF_loop           <- data.frame(matrix(nrow = 1, ncol = 12)) # create dataframe to save during for loop
# 
# colnames(DF_loop) <- c('Date', 'Metric', 'model', 'ShapiroWilk', 
#                        'ResidNorm', 'Levenes', 'HomogVar', 
#                        'DF.num' , 'DF.denom',  'F_val','P_val', 'SigDif') # names for comuns in the for loop
# 
# cols_m_loop       <- as.data.frame(c('SE','OIR','FR_correct', 
#                                      'CR_correct', 'RR_Percent',
#                                      'OIR','AR','AE')) %>% 
#                     `colnames<-`('biodep_meas')
# 
# for (i in 1:nrow(ANOVA_Dates)) {
#   
#   date_loop     <- as.character(ANOVA_Dates[i,])
#   data_loop     <- Biodep_Master_F1 %>% 
#                           dplyr::filter(Date %in% date_loop) %>% 
#                           dplyr::select(Date, treatment, tank_ID.x, cols_m_loop$biodep_meas)
#   
#         for (m in 4:ncol(data_loop)) { # run anova and normality tests for each of these wihtin data i
#         # high cholorphyll model
#         
#         date_loop_MEAN <- as.data.frame(
#                               data_loop %>% 
#                               summarySE(measurevar=colnames(data_loop[m]), 
#                                         groupvars=c("Date","treatment","tank_ID.x")) 
#                               )
#           
#         DF_loop$Date        <- date_loop
#         DF_loop$Metric      <- colnames(date_loop_MEAN[5])
#         
#         # run both modles
#         AOVmod              <- aov(lm(date_loop_MEAN[,5] ~ as.factor(date_loop_MEAN$treatment)))
#         KWmod               <- kruskal.test(date_loop_MEAN[,5]  ~ as.factor(date_loop_MEAN$treatment))
#         
#         # normality tests for the anova model - asign 
#         DF_loop$ShapiroWilk <- shapiro.test(resid(AOVmod))[[2]]
#         DF_loop$ResidNorm   <- if( shapiro.test(resid(AOVmod))[[2]] > 0.05) {
#           'YES'} else {'NO'}
#         DF_loop$Levenes     <- leveneTest(AOVmod)[[3]][[1]]
#         DF_loop$HomogVar    <- if( leveneTest(AOVmod)[[3]][[1]] > 0.05) {
#           'YES'} else {'NO'}
#         
#        if(shapiro.test(resid(AOVmod))[[2]] > 0.05 & leveneTest(AOVmod)[[3]][[1]] > 0.05) {
#           DF_loop$model       <- 'one-way AOV; x ~ treatment'
#           DF_loop$DF.num      <- summary(AOVmod)[[1]][["Df"]][1]
#           DF_loop$DF.denom    <- summary(AOVmod)[[1]][["Df"]][2]
#           DF_loop$F_val       <- summary(AOVmod)[[1]][["F value"]][1]
#           DF_loop$P_val       <- summary(AOVmod)[[1]][["Pr(>F)"]][1]
#           DF_loop$SigDif      <- if( (summary(AOVmod)[[1]][["Pr(>F)"]][1]) > 0.05) {
#             'NO'} else {'YES'}
# 
#         } else {
#           DF_loop$model       <- 'kruskal-wallis; x ~ treatment'
#           DF_loop$DF.num      <- (KWmod)[[2]][["df"]][1]
#           DF_loop$DF.denom    <- NA
#           DF_loop$F_val       <- NA
#           DF_loop$P_val       <- (KWmod)[[3]]
#           DF_loop$SigDif      <- if( ((KWmod)[[3]]) > 0.05) {
#             'NO'} else {'YES'}
#         }
#         
#         # asign loop and cumulative output table
#         df          <- data.frame(DF_loop) # name dataframe for this single row
#         AOVdf_total <- rbind(AOVdf_total,DF_loop) #bind to a cumulative list dataframe
#         print(AOVdf_total) # print to monitor progress
#         }
# }
# View(AOVdf_total) # view all the anova tests within data 
# View(AOVdf_total %>% dplyr::filter(P_val < 0.05))
# # WRITE CSV OF THE MASTER FILE
# write.csv(AOVdf_total, "C:/Users/samjg/Documents/Github_repositories/EAD-ASEB-Airradians_F1F2_Growout_OA/RAnalysis/Output/Biodeposition/F1/F1_Biodeposition_ANOVA_table.csv")
# 
# 
# 
# ```


```{r two way anovas}

library(rcompanion)
library(FSA)

# Absorption Efficiency
AOV_AE <- lm(AE ~ as.factor(Age)*as.factor(treatment),data = Biodep_Master_F1)
shapiro.test(resid(AOV_AE)) # 0.00068
leveneTest(aov(AOV_AE))
SRH_AE <- scheirerRayHare(AE ~ as.factor(Age)*as.factor(treatment),data = Biodep_Master_F1)
# Df Sum Sq       H p.value
# Age            2 4502.0 28.5542 0.00000
# treatment      1  308.1  1.9542 0.16214
# Age:treatment  2   72.0  0.4564 0.7959
DT_AE <- dunnTest(AE ~ as.factor(Age),
              data=Biodep_Master_F1,
              method="bh") 
DT_AE





# Absorption Efficiency
AOV_SE <- lm(SE ~ as.factor(Age)*as.factor(treatment),data = Biodep_Master_F1)
shapiro.test(resid(AOV_SE)) # 5.702e-09
SRH_SE <- scheirerRayHare(SE ~ as.factor(Age)*as.factor(treatment),data = Biodep_Master_F1)
#               Df Sum Sq       H p.value
# Age            2 4724.9 29.9678 0.00000
# treatment      1  153.4  0.9732 0.32389
# Age:treatment  2    0.6  0.0039 0.99806
DT_SE <- dunnTest(SE ~ as.factor(Age),
              data=Biodep_Master_F1,
              method="bh") 
DT_SE



# Absorption ERate
AOV_AR <- lm(AR ~ as.factor(Age)*as.factor(treatment),data = Biodep_Master_F1)
shapiro.test(resid(AOV_AR)) # 0.3729
summary(aov(AOV_AR))
#                                     Df Sum Sq Mean Sq F value   Pr(>F)    
# as.factor(Age)                       2  84.05   42.03  21.852 5.42e-07 ***
# as.factor(treatment)                 1   1.15    1.15   0.597    0.445    
# as.factor(Age):as.factor(treatment)  2   0.25    0.12   0.064    0.938    
# Residuals                           37  71.16    1.92
TukeyHSD(aov(AOV_AR))
# $`as.factor(Age)`
#             diff        lwr      upr     p adj
# 261-219 1.021620 -0.2426561 2.285897 0.1331744
# 424-219 3.305687  2.0665722 4.544801 0.0000004
# 424-261 2.284066  0.9799360 3.588196 0.0003701



# Clearance Rate (corrected)
AOV_CR <- lm(CR_correct ~ as.factor(Age)*as.factor(treatment),data = Biodep_Master_F1)
shapiro.test(resid(AOV_CR)) # 0.122
summary(aov(AOV_CR))
#                                     Df Sum Sq Mean Sq F value  Pr(>F)   
# as.factor(Age)                       2  26.46  13.230   6.356 0.00424 **
# as.factor(treatment)                 1   0.92   0.923   0.443 0.50963   
# as.factor(Age):as.factor(treatment)  2   0.65   0.327   0.157 0.85538   
# Residuals                           37  77.02   2.082
TukeyHSD(aov(AOV_CR))
# $`as.factor(Age)`
#              diff         lwr      upr     p adj
# 261-219 0.5986824 -0.71659403 1.913959 0.5132735
# 424-219 1.8590387  0.56993949 3.148138 0.0032531
# 424-261 1.2603562 -0.09638149 2.617094 0.0731192



# Rejection Rate (corrected)
AOV_RR <- lm(RR_correct ~ as.factor(Age)*as.factor(treatment),data = Biodep_Master_F1)
shapiro.test(resid(AOV_RR)) # 0.04109
SRH_RR <- scheirerRayHare(RR_correct ~ as.factor(Age)*as.factor(treatment),data = Biodep_Master_F1)
SRH_RR
#               Df Sum Sq      H p.value
# Age            2  792.4 5.0257 0.08104
# treatment      1  120.8 0.7660 0.38145
# Age:treatment  2  397.5 2.5213 0.28347


# Organic Ingestion Rate
AOV_OIR <- lm(OIR ~ as.factor(Age)*as.factor(treatment),data = Biodep_Master_F1)
shapiro.test(resid(AOV_OIR)) # 0.2691
summary(aov(AOV_OIR))
#                                     Df Sum Sq Mean Sq F value   Pr(>F)    
# as.factor(Age)                       2  64.00   32.00  12.467 7.26e-05 ***
# as.factor(treatment)                 1   0.89    0.89   0.348    0.559    
# as.factor(Age):as.factor(treatment)  2   0.86    0.43   0.167    0.846    
# Residuals                           37  94.97    2.57
TukeyHSD(aov(AOV_OIR))
# $`as.factor(Age)`
#              diff        lwr      upr     p adj
# 261-219 0.4401606 -1.0204093 1.900730 0.7439815
# 424-219 2.7724559  1.3409551 4.203957 0.0000947
# 424-261 2.3322953  0.8256842 3.838907 0.0015732
```

# plot significant results 
* F1 only FR_correct

```{r plots}
unique(Biodep_Master_F1$Date)
Biodep_Master_F1 <- Biodep_Master_F1 %>% 
                        dplyr::mutate(Age = case_when(Date == "20220302" ~  219, 
                                                       Date == "20220923" ~  424, 
                                                       Date == "20221027" ~  458)) %>% 
                        dplyr::mutate(pCO2 = case_when(treatment == 8 ~ "500 μatm", # add column for pCO2
                                                       treatment == 7.5 ~ "800 μatm")) %>% # %>% #edit this!
                        dplyr::mutate(pCO2 = fct_relevel(pCO2, c("500 μatm","800 μatm")),
                                      Temperature = case_when(Date == "20220302" ~  16,
                                                              Date == "20220923" ~  20,
                                                              Date == "20221027" ~  12))
                                                         

# what effects are sigificnat?
AOVdf_total %>% dplyr::filter(P_val < 0.05)
# 20220302	FR_correct		

# ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
# PLOTTING :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
# ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::


# Filtration rate correct

F1_FRcorrect_MEANS <- summarySE(Biodep_Master_F1, measurevar="FR_correct", 
                              groupvars=c("Age", "pCO2", "Temperature"))

F1_FRcorrect_Plot  <- F1_FRcorrect_MEANS %>% 
                          ggplot(aes(x=as.factor(Age), 
                                     y=FR_correct, 
                                     color=as.factor(pCO2))) +
                          geom_point(position=position_dodge(.5), size = 3)+ 
                          scale_color_manual(values=c("#228B22",
                                                      "#FFA500"))+
                          geom_errorbar(aes(ymin=FR_correct-se, 
                                            ymax=FR_correct+se), width=.2,
                                        position=position_dodge(.5))+
                          ggtitle("Filtration rate (correct)") +
                          theme_classic() +  
                          xlab("Age (dpf)") +
                         #xlab("Age (d)") +
                          theme(axis.text=element_text(size=10),
                                panel.grid.major = element_blank(), 
                                panel.grid.minor = element_blank(),
                                legend.position = "none")+ 
                          scale_y_continuous(name ="Filtration rate (correct)")+
                          geom_line(stat = "identity", size=1.0)+
                          theme(text = element_text(size=10))

# Selection Efficiency

F1_SE_MEANS <- summarySE(Biodep_Master_F1, measurevar="SE", 
                              groupvars=c("Age", "pCO2", "Temperature"))

F1_SE_Plot  <- F1_SE_MEANS %>% 
                          ggplot(aes(x=as.factor(Age), 
                                     y=SE, 
                                     color=as.factor(pCO2))) +
                          geom_point(position=position_dodge(.5),size = 3)+ 
                          scale_color_manual(values=c("#228B22",
                                                      "#FFA500"))+
                          geom_errorbar(aes(ymin=SE-se, 
                                            ymax=SE+se), width=.2,
                                        position=position_dodge(.5))+
                          ggtitle("Selection Efficiency") +
                          theme_classic() +  
                          xlab("Age (dpf)") +
                         #xlab("Age (d)") +
                          theme(axis.text=element_text(size=10),
                                panel.grid.major = element_blank(), 
                                panel.grid.minor = element_blank(),
                                legend.position = "none")+ 
                          scale_y_continuous(name ="Selection Efficiency")+
                          geom_line(stat = "identity", size=1.0)+
                          theme(text = element_text(size=10))

# Orgnaic Ingestion Rate

F1_OIR_MEANS <- summarySE(Biodep_Master_F1, measurevar="OIR", 
                              groupvars=c("Age", "pCO2", "Temperature"))

F1_OIR_Plot  <- F1_OIR_MEANS %>% 
                          ggplot(aes(x=as.factor(Age), 
                                     y=OIR, 
                                     color=as.factor(pCO2))) +
                          geom_point(position=position_dodge(.5),size = 3)+ 
                          scale_color_manual(values=c("#228B22",
                                                      "#FFA500"))+
                          geom_errorbar(aes(ymin=OIR-se, 
                                            ymax=OIR+se), width=.2,
                                        position=position_dodge(.5))+
                          ggtitle("Organic Ingestion Rate") +
                          theme_classic() +  
                          xlab("Age (dpf)") +
                         #xlab("Age (d)") +
                          theme(axis.text=element_text(size=10),
                                panel.grid.major = element_blank(), 
                                panel.grid.minor = element_blank(),
                                legend.position = "none")+ 
                          scale_y_continuous(name ="Orgnaic Ingestion Rate")+
                          geom_line(stat = "identity", size=1.0)+
                          theme(text = element_text(size=10))


# Clearance Rate (corrected)

F1_CR_correct_MEANS <- summarySE(Biodep_Master_F1, measurevar="CR_correct", 
                              groupvars=c("Age", "pCO2", "Temperature"))

F1_CR_correct_Plot  <- F1_CR_correct_MEANS %>% 
                          ggplot(aes(x=as.factor(Age), 
                                     y=CR_correct, 
                                     color=as.factor(pCO2))) +
                          geom_point(position=position_dodge(.5),size = 3)+ 
                          scale_color_manual(values=c("#228B22",
                                                      "#FFA500"))+
                          geom_errorbar(aes(ymin=CR_correct-se, 
                                            ymax=CR_correct+se), width=.2,
                                        position=position_dodge(.5))+
                          ggtitle("Clearance Rate (corrected)") +
                          theme_classic() +  
                          xlab("Age (dpf)") +
                         #xlab("Age (d)") +
                          theme(axis.text=element_text(size=10),
                                panel.grid.major = element_blank(), 
                                panel.grid.minor = element_blank(),
                                legend.position = "none")+ 
                          scale_y_continuous(name ="Clearance Rate (corrected)")+
                          geom_line(stat = "identity", size=1.0)+
                          theme(text = element_text(size=10))

# Rejection Rate (corrected)

F1_RR_correct_MEANS <- summarySE(Biodep_Master_F1, measurevar="RR_correct", 
                              groupvars=c("Age", "pCO2", "Temperature"))

F1_RR_correct_Plot  <- F1_RR_correct_MEANS %>% 
                          ggplot(aes(x=as.factor(Age), 
                                     y=RR_correct, 
                                     color=as.factor(pCO2))) +
                          geom_point(position=position_dodge(.5),size = 3)+ 
                          scale_color_manual(values=c("#228B22",
                                                      "#FFA500"))+
                          geom_errorbar(aes(ymin=RR_correct-se, 
                                            ymax=RR_correct+se), width=.2,
                                        position=position_dodge(.5))+
                          ggtitle("Rejection Rate (corrected)") +
                          theme_classic() +  
                          xlab("Age (dpf)") +
                         #xlab("Age (d)") +
                          theme(axis.text=element_text(size=10),
                                panel.grid.major = element_blank(), 
                                panel.grid.minor = element_blank(),
                                legend.position = "none")+ 
                          scale_y_continuous(name ="Rejection Rate (corrected)")+
                          geom_line(stat = "identity", size=1.0)+
                          theme(text = element_text(size=10))

# Absorption Rate 

F1_AR_MEANS <- summarySE(Biodep_Master_F1, measurevar="AR", 
                              groupvars=c("Age", "pCO2", "Temperature"))

F1_AR_Plot  <- F1_AR_MEANS %>% 
                          ggplot(aes(x=as.factor(Age), 
                                     y=AR, 
                                     color=as.factor(pCO2))) +
                          geom_point(position=position_dodge(.5),size = 3)+ 
                          scale_color_manual(values=c("#228B22",
                                                      "#FFA500"))+
                          geom_errorbar(aes(ymin=AR-se, 
                                            ymax=AR+se), 
                                        width=.2,
                                        position=position_dodge(.5))+
                          ggtitle("Absorption Rate") +
                          theme_classic() +  
                          xlab("Age (dpf)") +
                         #xlab("Age (d)") +
                          theme(axis.text=element_text(size=10),
                                panel.grid.major = element_blank(), 
                                panel.grid.minor = element_blank(),
                                legend.position = "none")+ 
                          scale_y_continuous(name ="Absorption Rate")+
                          geom_line(stat = "identity", size=1.0)+
                          theme(text = element_text(size=10))

# Absorption Efficiency 

F1_AE_MEANS <- summarySE(Biodep_Master_F1, measurevar="AE", 
                              groupvars=c("Age", "pCO2", "Temperature"))

F1_AE_Plot  <- F1_AE_MEANS %>% 
                          ggplot(aes(x=as.factor(Age), 
                                     y=AE, 
                                     color=as.factor(pCO2))) +
                          geom_point(aes(y=AE),position=position_dodge(.5),size = 3)+ 
                          # geom_line( aes(y=Temperature), color = "orangered3", size = 1) +
                          # geom_line(aes(y = Temperature), color = "orangered3", size = 1) +
                          scale_color_manual(values=c("#228B22",
                                                      "#FFA500"))+
                          geom_errorbar(aes(ymin=AE-se, 
                                            ymax=AE+se), 
                                        width=.2,
                                        position=position_dodge(.5))+
                          ggtitle("Absorption Efficiency") +
                          theme_classic() +  
                          xlab("Age (dpf)") +
                         #xlab("Age (d)") +
                          theme(axis.text=element_text(size=10),
                                panel.grid.major = element_blank(), 
                                panel.grid.minor = element_blank(),
                                legend.position = "none")+ 
                          scale_y_continuous(name ="Absorption Efficiency") +
                          geom_line(stat = "identity", size=1.0)+
                          theme(text = element_text(size=10))

ggpubr::ggarrange(F1_OIR_Plot,F1_RR_correct_Plot, F1_CR_correct_Plot,
          F1_SE_Plot, F1_AR_Plot, F1_AE_Plot,
          ncol = 3, nrow = 2)
# output the plot 
library(ggpubr)
pdf(paste0("Output/Biodeposition/F1/F1_Biodeposition_Boxplots.pdf"),width = 9, height= 6)
ggpubr::ggarrange(F1_OIR_Plot,F1_RR_correct_Plot, F1_CR_correct_Plot,
          F1_SE_Plot, F1_AR_Plot, F1_AE_Plot,
          ncol = 3, nrow = 2)
dev.off()


```

# F2S ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::

Biodep_Master_F2$pCO2 <- factor(Biodep_Master_F2$pCO2, 
                                levels = c("500 μatm", "800 μatm", "1200 μatm"))


AE_boxplot_F2 <- Biodep_Master_F2 %>% 
  ggplot(aes(pCO2 , AE , fill = pCO2)) +
  theme(panel.grid=element_blank()) +
  geom_boxplot(size=0.2, alpha=0.1, aes(fill=pCO2)) +
  scale_fill_manual(values=c("forestgreen","orange", "purple")) +
  geom_point(shape = 21, size = 2, position = position_jitterdodge(jitter.width = 0.1)) +
  theme_classic() +
  theme(axis.text=element_text(size=6),
        axis.title=element_text(size=6)) +
  stat_summary(fun.y=mean, geom="point", shape=18, size=4, color="black", fill="white") +
  ggtitle("Assimilation Efficiency, F2 Scallops") +
  theme(axis.text.x=element_blank()) +
  facet_wrap(~Date)
# AE_boxplot


AR_boxplot_F2 <- Biodep_Master_F2 %>% 
  ggplot(aes(pCO2 , AR , fill = pCO2)) +
  theme(panel.grid=element_blank()) +
  geom_boxplot(size=0.2, alpha=0.1, aes(fill=pCO2)) +
  scale_fill_manual(values=c("forestgreen","orange", "purple")) +
  geom_point(shape = 21, size = 2, position = position_jitterdodge(jitter.width = 0.1)) +
  theme_classic() +
  theme(axis.text=element_text(size=6),
        axis.title=element_text(size=6)) +
  stat_summary(fun.y=mean, geom="point", shape=18, size=4, color="black", fill="white") +
  ggtitle("Assimilation Rate, F2 Scallops") +
  theme(axis.text.x=element_blank()) +
  facet_wrap(~Date)
# AR_boxplot

OIR_boxplot_F2 <- Biodep_Master_F2 %>% 
  ggplot(aes(pCO2 , OIR , fill = pCO2)) +
  theme(panel.grid=element_blank()) +
  geom_boxplot(size=0.2, alpha=0.1, aes(fill=pCO2)) +
  scale_fill_manual(values=c("forestgreen","orange", "purple")) +
  geom_point(shape = 21, size = 2, position = position_jitterdodge(jitter.width = 0.1)) +
  theme_classic() +
  theme(axis.text=element_text(size=6),
        axis.title=element_text(size=6)) +
  stat_summary(fun.y=mean, geom="point", shape=18, size=4, color="black", fill="white") +
  ggtitle("Organic Ingestion Rate, F2 Scallops") +
  theme(axis.text.x=element_blank()) +
  facet_wrap(~Date)
# OIR_boxplot


FR_boxplot_F2 <- Biodep_Master_F2 %>% 
  ggplot(aes(pCO2 , FR , fill = pCO2)) +
  theme(panel.grid=element_blank()) +
  geom_boxplot(size=0.2, alpha=0.1, aes(fill=pCO2)) +
  scale_fill_manual(values=c("forestgreen","orange", "purple")) +
  geom_point(shape = 21, size = 2, position = position_jitterdodge(jitter.width = 0.1)) +
  theme_classic() +
  theme(axis.text=element_text(size=6),
        axis.title=element_text(size=6)) +
  stat_summary(fun.y=mean, geom="point", shape=18, size=4, color="black", fill="white") +
  ggtitle("Filtration Rate, F2 Scallops") +
  theme(axis.text.x=element_blank()) +
  facet_wrap(~Date)
# FR_boxplot

RR_boxplot_F2 <- Biodep_Master_F2 %>% 
  ggplot(aes(pCO2 , RR_Percent , fill = pCO2)) +
  theme(panel.grid=element_blank()) +
  geom_boxplot(size=0.2, alpha=0.1, aes(fill=pCO2)) +
  scale_fill_manual(values=c("forestgreen","orange", "purple")) +
  geom_point(shape = 21, size = 2, position = position_jitterdodge(jitter.width = 0.1)) +
  theme_classic() +
  theme(axis.text=element_text(size=6),
        axis.title=element_text(size=6)) +
  stat_summary(fun.y=mean, geom="point", shape=18, size=4, color="black", fill="white") +
  ggtitle("Percent Rejection Rate, F2 Scallops") +
  theme(axis.text.x=element_blank()) +
  facet_wrap(~Date)
# RR_boxplot

SE_boxplot_F2 <- Biodep_Master_F2 %>% 
  ggplot(aes(pCO2 , SE , fill = pCO2)) +
  theme(panel.grid=element_blank()) +
  geom_boxplot(size=0.2, alpha=0.1, aes(fill=pCO2)) +
  scale_fill_manual(values=c("forestgreen","orange", "purple")) +
  geom_point(shape = 21, size = 2, position = position_jitterdodge(jitter.width = 0.1)) +
  theme_classic() +
  theme(axis.text=element_text(size=6),
        axis.title=element_text(size=6)) +
  stat_summary(fun.y=mean, geom="point", shape=18, size=4, color="black", fill="white") +
  ggtitle("Selection Efficiency, F2 Scallops") +
  theme(axis.text.x=element_blank()) +
  facet_wrap(~Date)
# SE_boxplot

# output the plot 
library(ggpubr)
pdf(paste0("C:/Users/samjg/Documents/Github_repositories/EAD-ASEB-Airradians_F1F2_Growout_OA/RAnalysis/Output/Biodeposition/F2_Biodeposition_Boxplots.pdf"), width = 10, height= 8)
ggarrange(SE_boxplot_F2,
          RR_boxplot_F2, 
          OIR_boxplot_F2, 
          FR_boxplot_F2, 
          AE_boxplot_F2, 
          AR_boxplot_F2)
dev.off()










































CR_correct_boxplot <- Biodep_Master %>% 
  dplyr::mutate(Temperature = case_when(Date == '20220302' ~ '16C', 
                                        Date == '20220923' ~ '20C',
                                        Date == '20221027' ~ '13.3C')) %>%  
  #filter(!AE < 0) %>% 
  ggplot(aes(pCO2 , CR_correct , fill = pCO2)) +
  theme(panel.grid=element_blank()) +
  geom_boxplot(size=0.2, alpha=0.1, aes(fill=pCO2)) +
  scale_fill_manual(values=c("forestgreen","orange")) +
  geom_point(shape = 21, size = 2, position = position_jitterdodge(jitter.width = 0.1)) +
  theme_classic() +
  theme(axis.text=element_text(size=6),
        axis.title=element_text(size=6)) +
  stat_summary(fun.y=mean, geom="point", shape=18, size=4, color="black", fill="white") +
  ggtitle("Clearance Rate, F1 Scallops") +
  theme(axis.text.x=element_blank()) +
  facet_wrap(~Temperature)
CR_correct_boxplot
 





#  KAITE'S mas POSTER FIGURE FOR MAS 2022

Biodep_Master_16_20C <- Biodep_Master %>% 
  dplyr::mutate(Temperature = case_when(Date == '20220302' ~ '16C', 
                                        Date == '20220923' ~ '20C',
                                        Date == '20221027' ~ '13.3C')) %>%  
  dplyr::filter(Temperature %in% c('16C', '20C'))



AE_boxplot <- Biodep_Master_16_20C %>% 
  ggplot(aes(pCO2 , AE , fill = pCO2)) +
  theme(panel.grid=element_blank()) +
  geom_boxplot(size=0.2, alpha=0.1, aes(fill=pCO2)) +
  scale_fill_manual(values=c("forestgreen","orange")) +
  geom_point(shape = 21, size = 2, position = position_jitterdodge(jitter.width = 0.1)) +
  theme_classic() +
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=12)) +
  stat_summary(fun.y=mean, geom="point", shape=18, size=4, color="black", fill="white") +
  ggtitle("Assimilation Efficiency") +
  theme(axis.text.x=element_blank(),axis.title.x = element_blank()) +
  facet_wrap(~Temperature)
# AE_boxplot

OIR_boxplot <- Biodep_Master_16_20C %>% 
  ggplot(aes(pCO2 , OIR , fill = pCO2)) +
  theme(panel.grid=element_blank()) +
  geom_boxplot(size=0.2, alpha=0.1, aes(fill=pCO2)) +
  scale_fill_manual(values=c("forestgreen","orange")) +
  geom_point(shape = 21, size = 2, position = position_jitterdodge(jitter.width = 0.1)) +
  theme_classic() +
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=12)) +
  stat_summary(fun.y=mean, geom="point", shape=18, size=4, color="black", fill="white") +
  ggtitle("Organic Ingestion Rate") +
  theme(axis.text.x=element_blank(),axis.title.x = element_blank(),legend.position = "none") +
  facet_wrap(~Temperature)
# OIR_boxplot


FR_boxplot <- Biodep_Master_16_20C %>% 
  ggplot(aes(pCO2 , FR , fill = pCO2)) +
  theme(panel.grid=element_blank()) +
  geom_boxplot(size=0.2, alpha=0.1, aes(fill=pCO2)) +
  scale_fill_manual(values=c("forestgreen","orange")) +
  geom_point(shape = 21, size = 2, position = position_jitterdodge(jitter.width = 0.1)) +
  theme_classic() +
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=12)) +
  stat_summary(fun.y=mean, geom="point", shape=18, size=4, color="black", fill="white") +
  ggtitle("Filtration Rate") +
  theme(axis.text.x=element_blank(),axis.title.x = element_blank(),legend.position = "none") +
  facet_wrap(~Temperature)
# FR_boxplot

RR_boxplot <- Biodep_Master_16_20C %>% 
  ggplot(aes(pCO2 , RR_Percent , fill = pCO2)) +
  theme(panel.grid=element_blank()) +
  geom_boxplot(size=0.2, alpha=0.1, aes(fill=pCO2)) +
  scale_fill_manual(values=c("forestgreen","orange")) +
  geom_point(shape = 21, size = 2, position = position_jitterdodge(jitter.width = 0.1)) +
  theme_classic() +
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=12)) +
  stat_summary(fun.y=mean, geom="point", shape=18, size=4, color="black", fill="white") +
  ggtitle("Percent Rejection Rate") +
  theme(axis.text.x=element_blank(),axis.title.x = element_blank(),legend.position = "none") +
  facet_wrap(~Temperature)
# RR_boxplot

SE_boxplot <- Biodep_Master_16_20C %>% 
  ggplot(aes(pCO2 , SE , fill = pCO2)) +
  theme(panel.grid=element_blank()) +
  geom_boxplot(size=0.2, alpha=0.1, aes(fill=pCO2)) +
  scale_fill_manual(values=c("forestgreen","orange")) +
  geom_point(shape = 21, size = 2, position = position_jitterdodge(jitter.width = 0.1)) +
  theme_classic() +
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=12)) +
  stat_summary(fun.y=mean, geom="point", shape=18, size=4, color="black", fill="white") +
  ggtitle("Selection Efficiency") +
  theme(axis.text.x=element_blank(),axis.title.x = element_blank(),legend.position = "none") +
  facet_wrap(~Temperature)


pdf(paste0("C:/Users/samjg/Documents/Github_repositories/EAD-ASEB-Airradians_F1F2_Growout_OA/RAnalysis/Output/Biodeposition/Biodeposition_Boxplots_MAS_poster.pdf"), width = 20, height= 4)
ggarrange(SE_boxplot,RR_boxplot, OIR_boxplot, FR_boxplot, nrow = 1, ncol = 5)
dev.off()

pdf(paste0("C:/Users/samjg/Documents/Github_repositories/EAD-ASEB-Airradians_F1F2_Growout_OA/RAnalysis/Output/Biodeposition/AE_Boxplot_MAS_poster.pdf"), width = 5, height= 4)
ggarrange(AE_boxplot, nrow = 1, ncol = 1)
dev.off()